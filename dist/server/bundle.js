(()=>{"use strict";var e={857(e){e.exports=require("os")}},t={};function n(o){var r=t[o];if(void 0!==r)return r.exports;var a=t[o]={exports:{}};return e[o](a,a.exports,n),a.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);const o=require("express");var r=n.n(o);const a=require("http");var c=n.n(a);const i=require("body-parser");var s=n.n(i);const u=require("cookie-parser");var l=n.n(u);const f=require("hpp");var d=n.n(f);const p=require("path");var h=n.n(p);const y=require("fs/promises");var v=n.n(y),m=36e5,b="api/user",w=32,g=50,x=process.env.DB_PREFIX||"",I="".concat(x,"rooms"),O="".concat(x,"users"),j=["disposable","casual","dedicated"],S=[2592e5,6048e5,2592e6],k="https://thingspool.net",_="staging_"==process.env.DB_PREFIX?"https://staging.thingspool.net":"https://app.thingspool.net",T="public",R="views",P="2023-09-10";const D=function(){function e(e){this.listeners={},this.currValue=e}return e.prototype.notify=function(e){if(void 0!==this.currValue)if(e)null!=(o=this.listeners[e])?o(this.currValue):console.error("Unicast key not found in the map of listeners (key = ".concat(e,")"));else for(var t=0,n=Object.values(this.listeners);t<n.length;t++){var o;(o=n[t])(this.currValue)}else console.error("Current value is undefined")},e.prototype.set=function(e,t){this.currValue=e,this.notify(t)},e.prototype.change=function(e,t){if(void 0===this.currValue)throw new Error("Tried to apply a change to an undefined currValue in an Observable.");var n=e(this.currValue);this.set(n,t)},e.prototype.peek=function(){if(void 0===this.currValue)throw new Error("Tried to access an undefined currValue in an Observable.");return this.currValue},e.prototype.addListener=function(e,t){if(null!=this.listeners[e])throw new Error("Listener key already exists (key = ".concat(e,")"));this.listeners[e]=t},e.prototype.removeListener=function(e){if(void 0===this.listeners[e])throw new Error("Listener key doesn't exist (key = ".concat(e,")"));delete this.listeners[e]},e}();var M=new D,E=new D,U={thresholdLogLevel:0,setThresholdLogLevel:function(e){U.thresholdLogLevel=isNaN(e)?U.getLogLevelFromName(e):e},getThresholdLogLevel:function(){return U.thresholdLogLevel},getLogLevelFromName:function(e){switch(e){case"low":return 0;case"medium":return 1;case"high":return 2;default:console.error('ERROR: Unknown log level name ("'.concat(e,'")'))}return 0},log:function(e,t,n,o){void 0===t&&(t=void 0),void 0===n&&(n="high"),void 0===o&&(o="info");var r="";null!=t&&(r=JSON.stringify(t).substring(0,1024));var a=U.getLogLevelFromName(n);if(a>=U.thresholdLogLevel){M.set({eventTitle:e,eventDescJSON:r,logLevel:a,logType:o});var c="".concat(e," :: ").concat(r);switch(o){case"info":console.log(c);break;case"warn":console.warn(c);break;case"error":console.trace(c);break;default:throw new Error("Unknown log type: ".concat(o))}}},logRaw:function(e,t,n){void 0===t&&(t="medium"),void 0===n&&(n="info"),U.log(e,void 0,t,n)}};const L=U;var B=function(e,t,n,o){return new(n||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())})},C=function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},A={read:function(e,t){return B(void 0,void 0,void 0,function(){var n,o;return C(this,function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),n=A.getAbsoluteFilePath(e,t),[4,v().readFile(n,{encoding:"utf8"})];case 1:return[2,r.sent()];case 2:return o=r.sent(),L.log("Failed to read file",{relativeFilePath:e,err:o},"high","error"),[2,""];case 3:return[2]}})})},write:function(e,t,n){return B(void 0,void 0,void 0,function(){var o,r;return C(this,function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),o=A.getAbsoluteFilePath(e,n),[4,v().writeFile(o,t)];case 1:return a.sent(),[3,3];case 2:return r=a.sent(),L.log("Failed to write file",{relativeFilePath:e,err:r},"high","error"),[3,3];case 3:return[2]}})})},getAllRelativePathsInDirRecursively:function(e){return B(void 0,void 0,void 0,function(){var t,n;return C(this,function(o){switch(o.label){case 0:return t=h().join(process.env.PWD,e),n=[],[4,A.getAllRelativePathsInDirRecursively_internal(t,[],n)];case 1:return o.sent(),[2,n]}})})},getAbsoluteFilePath:function(e,t){return null==t&&(t=T),h().join(process.env.PWD,t+"/"+e)},getAllRelativePathsInDirRecursively_internal:function(e,t,n){return B(this,void 0,void 0,function(){var o,r,a,c,i,s;return C(this,function(u){switch(u.label){case 0:return[4,v().readdir(e)];case 1:o=u.sent(),r=0,a=o,u.label=2;case 2:return r<a.length?(c=a[r],i=t.concat(c),s="".concat(e,"/").concat(c),[4,v().lstat(s)]):[3,7];case 3:return u.sent().isFile()?(n.push(i.join("/")),[3,6]):[3,4];case 4:return[4,A.getAllRelativePathsInDirRecursively_internal(s,i,n)];case 5:u.sent(),u.label=6;case 6:return r++,[3,2];case 7:return[2]}})})}};const N=A,G=require("ejs");var F=n.n(G),q=(n(857),"dev"==process.env.MODE),z={getErrorPageURL:function(e){return"".concat(z.getEnvStaticURL(),"/error/").concat(e,".html")},getMyPageURL:function(){return"".concat(z.getEnvDynamicURL(),"/mypage")},getEnvStaticURL:function(){return q?V():k},getEnvDynamicURL:function(){return q?V():_}};function V(){return"http://".concat("localhost",":").concat(process.env.PORT)}const W=z;var J="".concat(process.env.PWD,"/").concat(R,"/partial"),Y={PAGE_NAME_MAP:{index:"Home",arcade:"Arcade",library:"Library",portfolio:"Portfolio"},URL_STATIC:k,URL_DYNAMIC:_,ejsPartialRootPath:J,isStaticPage:!0},H={URL_STATIC:k,URL_DYNAMIC:_,ejsPartialRootPath:J,isStaticPage:!1},X={},Q={render:function(e,t,n,o){t.render(n,Q.makeEJSParams(e,o),function(e,n){e?t.status(500).send(e.message):(n=Q.postProcessHTML(n),t.status(200).setHeader("content-type","text/html").send(n))})},postProcessHTML:function(e){return"dev"==process.env.MODE?e=e.replaceAll("\n","!*NEW_LINE*!").replace(/(PROD_CODE_BEGIN).*?(PROD_CODE_END)/g,"REMOVED_PROD_CODE").replaceAll("!*NEW_LINE*!","\n").replaceAll(k,W.getEnvStaticURL()).replaceAll(_,W.getEnvDynamicURL()):e},makeEJSParams:function(e,t){var n={};return Object.assign(n,H),Object.assign(n,t),n.userString&&L.log("'userString' shouldn't be defined manually in EJS params.",{mergedEJSParams:n},"high","error"),n.userString=e.userString,n.globalDictionary&&L.log("'globalDictionary' shouldn't be defined manually in EJS params.",{mergedEJSParams:n},"high","error"),n.globalDictionary={},n},makeEJSParamsStatic:function(e){var t={};return Object.assign(t,Y),Object.assign(t,e),t},createStaticHTMLFromEJS:function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return o=void 0,r=function(e,t,n){if(n||2===arguments.length)for(var o,r=0,a=t.length;r<a;r++)!o&&r in t||(o||(o=Array.prototype.slice.call(t,0,r)),o[r]=t[r]);return e.concat(o||Array.prototype.slice.call(t))}([e],t,!0),c=function(e,t){var n;return void 0===t&&(t={}),function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,function(o){switch(o.label){case 0:return null!=(n=X[e])?[3,2]:[4,N.read(e,R)];case 1:n=o.sent(),X[e]=n,o.label=2;case 2:return[2,F().compile(n)(Q.makeEJSParamsStatic(t))]}})},new((a=void 0)||(a=Promise))(function(e,t){function n(e){try{s(c.next(e))}catch(e){t(e)}}function i(e){try{s(c.throw(e))}catch(e){t(e)}}function s(t){var o;t.done?e(t.value):(o=t.value,o instanceof a?o:new a(function(e){e(o)})).then(n,i)}s((c=c.apply(o,r||[])).next())});var o,r,a,c}};const Z=Q;const K=function(){function e(){this.lines=["</urlset>"]}return e.prototype.addEntry=function(e,t){this.lines.push("</url>"),this.lines.push("  <lastmod>".concat(t,"</lastmod>")),this.lines.push("  <loc>".concat(k,"/").concat(e,"</loc>")),this.lines.push("<url>")},e.prototype.build=function(){return e=this,t=void 0,o=function(){return function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,function(e){switch(e.label){case 0:return this.lines.push('<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">'),this.lines.push('<?xml version="1.0" encoding="UTF-8"?>'),this.lines.reverse(),[4,N.write("sitemap.xml",this.lines.join("\n"))];case 1:return e.sent(),[2]}})},new((n=void 0)||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())});var e,t,n,o},e}();const $=function(){function e(){this.lines=["</feed>"],this.globalLatestUpdate=new Date(P)}return e.prototype.addEntry=function(e,t,n,o){var r=new Date(n);r>this.globalLatestUpdate&&(this.globalLatestUpdate=r),this.lines.push("</entry>"),this.lines.push("  <summary>".concat(o,"</summary>")),this.lines.push("  <updated>".concat(r.toISOString(),"</updated>")),this.lines.push("  <id>".concat(e,"</id>")),this.lines.push('  <link href="'.concat(e,'"/>')),this.lines.push("  <title>".concat(t,"</title>")),this.lines.push("<entry>")},e.prototype.build=function(){return e=this,t=void 0,o=function(){return function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,function(e){switch(e.label){case 0:return this.lines.push("<id>urn:uuid:02210672-5391-4cc8-800a-2a88f3a6d00c</id>"),this.lines.push("</author>"),this.lines.push("  <name>Youngjin Kang</name>"),this.lines.push("<author>"),this.lines.push("<updated>".concat(this.globalLatestUpdate.toISOString(),"</updated>")),this.lines.push('<link href="'.concat(k,'"/>')),this.lines.push('<link rel="self" type="application/atom+xml" href="'.concat(k,'/feed.atom"/>')),this.lines.push("<title>ThingsPool</title>"),this.lines.push('<feed xmlns="http://www.w3.org/2005/Atom">'),this.lines.push('<?xml version="1.0" encoding="utf-8"?>'),this.lines.reverse(),[4,N.write("feed.atom",this.lines.join("\n"))];case 1:return e.sent(),[2]}})},new((n=void 0)||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())});var e,t,n,o},e}();const ee=function(){function e(){this.lines=[]}return e.prototype.addLine=function(e){this.lines.push(e)},e.prototype.getText=function(){return this.lines.join("\n")},e.prototype.build=function(e,t){return n=this,o=void 0,a=function(){return function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,function(n){switch(n.label){case 0:return null==t&&(t=T),[4,N.write(e,this.lines.join("\n"),t)];case 1:return n.sent(),[2]}})},new((r=void 0)||(r=Promise))(function(e,t){function c(e){try{s(a.next(e))}catch(e){t(e)}}function i(e){try{s(a.throw(e))}catch(e){t(e)}}function s(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r(function(e){e(n)})).then(c,i)}s((a=a.apply(n,o||[])).next())});var n,o,r,a},e}();var te=function(){function e(e,t){this.sitemapBuilder=e,this.atomFeedBuilder=t}return e.prototype.build=function(e){return t=this,n=void 0,r=function(){var t,n,o,r,a,c,i,s,u,l,f,d,p,h,y,v,m,b;return function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,function(w){switch(w.label){case 0:return t="".concat(e.dirName,"/page.html"),[4,N.read("".concat(e.dirName,"/source.txt"))];case 1:for(n=w.sent(),o=n.split(/\r?\n/),r=null==e.playLinkImagePathOverride?"play.png":e.playLinkImagePathOverride,a="",c="",o[0].startsWith(":d:")?a=o[0].substring(3):console.error(":d: is missing in -> "+e.title),o[1].startsWith(":k:")?c=o[1].substring(3).toLowerCase().replaceAll("-"," "):console.error(":k: is missing in -> "+e.title),i=[],s=1,u=[],l=function(){u.length>0&&(i.push("<p>".concat(u.join("<br>"),"</p>")),u.length=0)},f=2;f<o.length;++f)0==(d=(d=o[f]).trim()).length?l():d.startsWith("[")?(l(),(p=d.match(/\[(.*?)\]/)[1].trim()).length>0&&i.push("<h2>".concat(p,"</h2>"))):d.startsWith("<")?(l(),(h=d.match(/<(.*?)>/)[1]).length>0&&(y="".concat(k,"/").concat(e.dirName,"/").concat(h,".jpg"),i.push('<img class="l_image" src="'.concat(y,'" alt="ThingsPool - ').concat(e.title," (Screenshot ").concat(s++,')">')))):(d=d.replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll("{%","<").replaceAll("%}",">"),u.push(d));return l(),null!=e.videoTag&&null!=e.videoTag&&i.push(e.videoTag),v=new ee,b=(m=v).addLine,[4,Z.createStaticHTMLFromEJS("page/static/arcadeGame.ejs",{entry:e,relativeURL:t,description:a,keywords:c,playLinkImagePath:r,content:i.join("\n")})];case 2:return b.apply(m,[w.sent()]),this.sitemapBuilder.addEntry(t,e.lastmod),this.atomFeedBuilder.addEntry("".concat(k,"/").concat(t),e.title,e.lastmod,e.title),[4,v.build(t)];case 3:return w.sent(),[2]}})},new((o=void 0)||(o=Promise))(function(e,a){function c(e){try{s(r.next(e))}catch(e){a(e)}}function i(e){try{s(r.throw(e))}catch(e){a(e)}}function s(t){var n;t.done?e(t.value):(n=t.value,n instanceof o?n:new o(function(e){e(n)})).then(c,i)}s((r=r.apply(t,n||[])).next())});var t,n,o,r},e}();const ne=te;var oe={gameEntries:[{dirName:"ArtRaider",title:"ArtRaider",playLinkImagePathOverride:"badge_onestore.png",playLinkURL:"https://onesto.re/0001000383",videoTag:'<iframe width="560" height="315" src="https://www.youtube.com/embed/RuLgOJrNtKA?si=Ts_Yu_jdpB1qmNiT" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>',lastmod:"2025-04-15"},{dirName:"Water-vs-Fire",title:"Water vs Fire",playLinkURL:"https://www.gamearter.com/game/water-vs-fire",videoTag:'<iframe width="560" height="315" src="https://www.youtube.com/embed/6DeA_m8Iq4M?si=hC1uzkEtBWpYcM8z" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>',lastmod:"2023-09-10"},{dirName:"HuntLand",title:"HuntLand",playLinkURL:"https://www.gamearter.com/game/huntland",videoTag:'<iframe width="560" height="315" src="https://www.youtube.com/embed/3dRg6vvoPqc?si=FlnKVyzQq0_55sL2" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>',lastmod:"2023-09-10"},{dirName:"PoliceChase",title:"Police Chase",playLinkURL:"https://www.gamearter.com/game/policechase",videoTag:'<iframe width="560" height="315" src="https://www.youtube.com/embed/kABg0j2mZqQ?si=3-JUZQnh3omVXSJd" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>',lastmod:"2023-09-10"},{dirName:"SpaceTown",title:"SpaceTown",playLinkURL:"https://www.gamearter.com/game/spacetown",videoTag:'<iframe width="560" height="315" src="https://www.youtube.com/embed/NoiQzEKJM-A?si=o8vTNqW1kxCJ4MnW" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>',lastmod:"2023-09-20"}]},re=function(){function e(e,t){this.sitemapBuilder=e,this.atomFeedBuilder=t}return e.prototype.build=function(){return e=this,t=void 0,o=function(){var e,t,n,o,r,a;return function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,function(c){switch(c.label){case 0:return e=new ee,n=(t=e).addLine,[4,Z.createStaticHTMLFromEJS("page/static/arcade.ejs",{entries:oe.gameEntries})];case 1:return n.apply(t,[c.sent()]),[4,e.build("arcade.html")];case 2:c.sent(),this.sitemapBuilder.addEntry("arcade.html","2025-02-28"),o=0,r=oe.gameEntries,c.label=3;case 3:return o<r.length?(a=r[o],[4,new ne(this.sitemapBuilder,this.atomFeedBuilder).build(a)]):[3,6];case 4:c.sent(),c.label=5;case 5:return o++,[3,3];case 6:return[2]}})},new((n=void 0)||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())});var e,t,n,o},e}();const ae=re;var ce=function(e,t,n,o){return new(n||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())})},ie=function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},se=function(){function e(e,t){this.sitemapBuilder=e,this.atomFeedBuilder=t}return e.prototype.build=function(e){return ce(this,void 0,void 0,function(){var t,n,o,r,a,c,i,s,u,l,f,d,p,h,y,v,m,b,w,g,x,I,O,j,S,_,T=this;return ie(this,function(R){switch(R.label){case 0:return t=!0,o=1,r=1,a=void 0,c=!1,i=!1,s=[],u=[],l=[],h=n="???",y=f="A writing by ThingsPool.",v=d="thingspool, software, engineering, philosophy",m=p=P,b=function(){s.length>0&&(c?l.push('<div class="snippet"><pre><code>'.concat(s.join("\n"),"</code></pre></div>")):i?l.push('<pre><div class="excerpt">'.concat(s.join("\n"),"</div></pre>")):l.push("<p>".concat(s.join("<br>"),"</p>")),s.length=0)},w=function(t,n,c,i,s){return ce(T,void 0,void 0,function(){var f,d,p,h;return ie(this,function(y){switch(y.label){case 0:return f="".concat(e.dirName,"/page-").concat(o,".html"),d=new ee,h=(p=d).addLine,[4,Z.createStaticHTMLFromEJS("page/static/libraryPost.ejs",{title:t,desc:c,keywords:i,customOGImagePath:a,entry:e,pageNumber:o,isLastPage:s,content:l.join("\n")})];case 1:return h.apply(p,[y.sent()]),[4,d.build(f)];case 2:return y.sent(),l.length=0,this.sitemapBuilder.addEntry(f,n),this.atomFeedBuilder.addEntry("".concat(k,"/").concat(f),t,n,c),u.push({pageNumber:o,title:t,lastmod:n,desc:c,keywords:i,customOGImagePath:a}),o++,r=1,a=void 0,[2]}})})},[4,N.read("".concat(e.dirName,"/source.txt"))];case 1:g=R.sent(),x=g.split(/\r?\n/),I=0,R.label=2;case 2:return I<x.length?(O=x[I],c||i||(O=O.trim()),0!=O.length?[3,3]:(c||i?s.push("\n"):b(),[3,7])):[3,8];case 3:return O.startsWith("[")?(b(),t||(h=n),n=O.match(/\[(.*?)\]/)[1].trim(),j=O.match(/\](.*?)$/)[1].trim(),t?[3,5]:[4,w(h,m,y,v,!1)]):[3,6];case 4:R.sent(),y=f,v=d,m=p,R.label=5;case 5:return t=!1,l.push("<h1>".concat(n,"</h1>")),l.push('<p class="dim">Author: Youngjin Kang&nbsp;&nbsp;&nbsp;Date: '.concat(j,"</p>")),[3,7];case 6:!O.startsWith("<")||c||i?O.startsWith("@@")?l.push(O.substring(2)):O.startsWith("#$")?(b(),c=!c):O.startsWith('#"')?(b(),i=!i):O.startsWith(":d:")?(t||(y=f),f=O.substring(3)):O.startsWith(":k:")?(t||(v=d),d=O.substring(3).toLowerCase().replaceAll("-"," ")):O.startsWith(":l:")?(t||(m=p),p=O.substring(3)):(O=O.replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll("{%","<").replaceAll("%}",">"),s.push(O)):(b(),(S=O.match(/<(.*?)>/)[1]).length>0&&(_="".concat(k,"/").concat(e.dirName,"/").concat(S,".jpg"),(null==a||O.endsWith("*"))&&(a=_),l.push('<img class="l_image" src="'.concat(_,'" alt="').concat(n.replaceAll('"',"&quot;")," (Figure ").concat(r++,')">')))),R.label=7;case 7:return++I,[3,2];case 8:return b(),[4,w(n,p,f,d,!0)];case 9:return R.sent(),[2,u]}})})},e}();const ue=se;var le=function(){function e(e,t){this.sitemapBuilder=e,this.atomFeedBuilder=t}return e.prototype.build=function(e,t){return n=this,o=void 0,a=function(){var e,n,o,r,a,c,i;return function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,function(s){switch(s.label){case 0:e=0,s.label=1;case 1:return e<t.length?(n=t[e],[4,new ue(this.sitemapBuilder,this.atomFeedBuilder).build(n)]):[3,6];case 2:return o=s.sent(),r="".concat(n.dirName,"/list.html"),a=new ee,i=(c=a).addLine,[4,Z.createStaticHTMLFromEJS("page/static/libraryPostList.ejs",{entry:n,listRelativeURL:r,postInfoList:o})];case 3:return i.apply(c,[s.sent()]),[4,a.build("".concat(n.dirName,"/list.html"))];case 4:s.sent(),this.sitemapBuilder.addEntry("".concat(n.dirName,"/list.html"),o.sort(function(e,t){return Date.parse(t.lastmod)-Date.parse(e.lastmod)}).pop().lastmod),s.label=5;case 5:return++e,[3,1];case 6:return[2]}})},new((r=void 0)||(r=Promise))(function(e,t){function c(e){try{s(a.next(e))}catch(e){t(e)}}function i(e){try{s(a.throw(e))}catch(e){t(e)}}function s(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r(function(e){e(n)})).then(c,i)}s((a=a.apply(n,o||[])).next())});var n,o,r,a},e}();const fe=le;var de={entriesByCategory:{Nonfiction:[{dirName:"metaphysics",title:"형이상학 (2013 - 2014)"},{dirName:"game-analysis",title:"게임분석 (2019)"},{dirName:"essays",title:"Miscellaneous Writings (2022 - 2024)"},{dirName:"blockchains",title:"On Legitimacy of Blockchains (2022)"},{dirName:"software-development",title:"Software Development (2022 - 2024)"},{dirName:"game-design",title:"Universal Laws of Game Design (2023)"},{dirName:"reality",title:"The Origin of Reality (2023)"},{dirName:"bridge-to-math",title:"A Layman's Bridge to Mathematics (2024)"},{dirName:"read-rec",title:"Recommended Readings (2024)"},{dirName:"morsels",title:"Morsels of Thought (2024)"},{dirName:"concepts-of-plan",title:"Concepts of a Plan (2025)"}],Fiction:[{dirName:"novels",title:"단편소설 (2012 - 2013)"},{dirName:"alien-job-interview",title:"Alien Job Interview (2022)"},{dirName:"infinite-treasures",title:"The Island of Infinite Treasures (2022)"},{dirName:"infsoc",title:"Influential Social Posts (2023)"},{dirName:"gamedev-journey",title:"A Game Developer's Journey (2023)"},{dirName:"sandwich",title:"Sandwich Engineering (2025)"}],Arts:[{dirName:"illustrations",title:"Illustrations (2009 - 2014)"},{dirName:"cartoons",title:"Cartoons (2011 - 2015)"}]}},pe=function(){function e(e,t){this.sitemapBuilder=e,this.atomFeedBuilder=t}return e.prototype.build=function(){return e=this,t=void 0,o=function(){var e,t,n,o,r,a,c,i;return function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,function(s){switch(s.label){case 0:return e=new ee,n=(t=e).addLine,[4,Z.createStaticHTMLFromEJS("page/static/library.ejs",{entriesByCategory:de.entriesByCategory,gameEntries:oe.gameEntries})];case 1:return n.apply(t,[s.sent()]),[4,e.build("library.html")];case 2:s.sent(),this.sitemapBuilder.addEntry("library.html","2025-02-28"),o=0,r=Object.entries(de.entriesByCategory),s.label=3;case 3:return o<r.length?(a=r[o],c=a[0],i=a[1],[4,new fe(this.sitemapBuilder,this.atomFeedBuilder).build(c,i)]):[3,6];case 4:s.sent(),s.label=5;case 5:return o++,[3,3];case 6:return[2]}})},new((n=void 0)||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())});var e,t,n,o},e}();const he=pe;var ye,ve,me,be="#101010",we="#303030",ge="#707070",xe="#a0a0a0",Ie="#c0c0c0",Oe="#d0c090",je="#70c060",Se="#b0a070",ke="17px",_e={unit:{landscape:{vertical:.6,horizontal:1},portrait:{vertical:1,horizontal:2.5}}},Te=400,Re=800,Pe=function(e,t,n,o,r,a){return"position: absolute;\n\tdisplay: block;\n\tleft: ".concat(e,"%;\n\tright: ").concat(t,"%;\n\ttop: ").concat(n,"%;\n\tbottom: ").concat(o,"%;\n\twidth: ").concat(r,"%;\n\theight: ").concat(a,"%;")},De=function(e,t){return"position: relative;\n\tdisplay: ".concat(e?"block":"inline-block",";\n\tmax-width: ").concat(t,";")},Me=function(e){return"position: relative;\n\tdisplay: ".concat(e?"block":"inline-block",";\n\tmax-width: none;\n\twidth: fit-content;\n\tblock-size: fit-content;")},Ee=function(e,t,n,o,r){void 0===o&&(o=!1),void 0===r&&(r=!1);var a=_e.unit[e?"landscape":"portrait"],c=(a.vertical*t).toFixed(2),i=(a.horizontal*n).toFixed(2),s=r?"0":"".concat(c,"%"),u=r?"0":"".concat(i,"%"),l=o?"0":"".concat(c,"%"),f=o?"0":"".concat(i,"%");return"padding: ".concat(s," ").concat(u," ").concat(s," ").concat(u,";\n\tmargin: ").concat(l," ").concat(f," ").concat(l," 0;")},Ue=function(e,t,n){return"font-size: ".concat(e,';\n\tfont-family: "Lucida Console", "Lucida Sans Typewriter", "Monaco", Consolas, monospace;\n\tfont-style: ').concat(t?"italic":"normal",";\n\tfont-weight: ").concat(n,";")},Le=function(e,t,n){return void 0===n&&(n=1),"background-color: ".concat(e,";\n\tcolor: ").concat(t,";").concat(n<1?"\n\topacity: ".concat(n,";"):"")},Be=function(e,t,n){return void 0===n&&(n=1),Le(e,t,n)+"\n\tborder-radius: 2vmin;"},Ce=function(e,t,n,o,r){return void 0===o&&(o="1.25"),void 0===r&&(r=1),Be(e,t,r)+"\n"+"\tborder-bottom: ".concat(o,"vmin ").concat(n," solid;")+"\n"+"\tborder-right: ".concat(o,"vmin ").concat(n," solid;")},Ae=function(e,t,n,o,r){return void 0===o&&(o="1.25"),void 0===r&&(r=1),Be(e,t,r)+"\n"+"\tborder: ".concat(o,"vmin ").concat(n," solid;")},Ne=Pe(0,0,0,0,100,100),Ge=Pe(0,86,0,0,14,100),Fe=Pe(0,0,0,88,100,12),qe=Pe(14,5,0,0,81,100),ze=Pe(0,2.5,12,0,95,88),Ve=Pe(0,0,0,86,100,14),We=Pe(0,0,14,0,100,80),Je=Pe(0,0,0,35,100,65),Ye=Pe(0,0,65,0,100,35),He=function(e){return 2*_e.unit[e?"landscape":"portrait"].horizontal},Xe=function(e){return De(!0,"".concat(100..toFixed(2),"%"))},Qe=function(e){return De(!0,"1%")},Ze=function(e){return Me(!0)},Ke=function(e){return De(!1,"".concat(100..toFixed(2),"%"))},$e=function(e){return De(!1,"".concat((50-He(e)).toFixed(2),"%"))},et=function(e){return De(!1,"".concat((33-He(e)).toFixed(2),"%"))},tt=function(e){return Me(!1)},nt=function(e){return Ee(e,1,1)},ot=function(e){return Ee(e,2,2)},rt=function(e){return Ee(e,4,4)},at=function(e){return Ee(e,2,1,!1,!0)},ct=function(e){return Ee(e,4,1,!1,!0)},it="min(".concat(1.8199999999999998.toFixed(2),"vmax, ").concat(16..toFixed(2),"px)"),st="min(".concat(2.1839999999999997.toFixed(2),"vmax, ").concat(19.2.toFixed(2),"px)"),ut="min(".concat(2.6207999999999996.toFixed(2),"vmax, ").concat(23.04.toFixed(2),"px)"),lt="min(".concat(3.1449599999999998.toFixed(2),"vmax, ").concat(27.648.toFixed(2),"px)"),ft="min(".concat(3.7739519999999995.toFixed(2),"vmax, ").concat(33.1776.toFixed(2),"px)"),dt=Ue(it,!1,Te),pt=Ue(it,!0,Te),ht=Ue(it,!1,Re),yt=(Ue(st,!0,Te),Ue(st,!0,Re)),vt=(Ue(ut,!0,Te),Ue(ut,!0,Re)),mt=(Ue(lt,!0,Te),Ue(lt,!0,Re)),bt=(Ue(ft,!0,Te),Ue(ft,!0,Re)),wt="opacity: 0;",gt=Le("#000000",Ie,.7),xt=Ce(Oe,we,Se,"1.25"),It=Le("#000000",Ie,.7),Ot=Ce(we,xe,Ie,"1.25"),jt=Le(we,Ie),St=(ye=Ie,void 0===ve&&(ve="1.25"),void 0===me&&(me=1),Le(we,Ie,me)+"\n"+"\tborder-bottom: ".concat(ve,"vmin ").concat(ye," solid;")),kt=Le(we,xe),_t=Le(xe,we),Tt=Le(we,ge),Rt=Le(we,Oe),Pt=Le(we,Se),Dt=Ce(we,xe,xe),Mt=Be(we,Ie),Et=Be(be,je),Ut=Be(be,je),Lt=Ce(be,xe,ge,"0.5"),Bt=Ce(be,xe,ge,"0.75"),Ct=Ce(ge,Ie,xe,"0.25"),At=Ae(we,Ie,ge,"0.1"),Nt=Ae(xe,Ie,Ie,"0.1"),Gt=function(e){return"\n@supports(-moz-appearance:none) {\n\t* {\n\t\tscrollbar-width: ".concat(e?"auto":"none",";\n\t\tscrollbar-color: ").concat(ge," ").concat(be,";\n\t}\n}\n::-webkit-scrollbar {\n\twidth: ").concat(e?ke:"0",";\n\theight: ").concat(e?ke:"0",";\n}\n::-webkit-scrollbar-track {\n\tbackground: ").concat(be,";\n}\n::-webkit-scrollbar-thumb {\n\tbackground: ").concat(ge,";\n\tborder-radius: ").concat("8px",";\n\tborder: ").concat("4px"," solid ").concat(be,";\n}\n::-webkit-scrollbar-thumb:hover {\n\tbackground: ").concat(xe,";\n}\niframe {\n\t").concat(Xe(),"\n\t").concat(at(e),"\n\t").concat(vt,"\n\t").concat(kt,"\n}\np {\n\t").concat(Xe(),"\n\t").concat(ct(e),"\n\t").concat(dt,"\n\t").concat(jt,"\n}\nh3 {\n\t").concat(Xe(),"\n\t").concat(ct(e),"\n\t").concat(yt,"\n\t").concat(Pt,"\n}\nh2 {\n\t").concat(Xe(),"\n\t").concat(ct(e),"\n\t").concat(mt,"\n\t").concat(Tt,"\n}\nh1 {\n\t").concat(Xe(),"\n\t").concat(ct(e),"\n\t").concat(bt,"\n\t").concat(Rt,"\n}\nhr {\n\t").concat(Xe(),"\n\t").concat(at(e),"\n\t").concat(jt,"\n}\n.fullscreenBar {\n\t").concat(e?Ge:Fe,"\n\t").concat("padding: 0 0 0 0; margin: 0 0 0 0;","\n\t").concat(yt,"\n\t").concat(_t,"\n\ttext-align: ").concat("center",";\n\tz-index: 1;\n\toverflow: hidden;\n}\n.fullscreenPanel {\n\t").concat(e?qe:ze,"\n\tmargin: 0 0 0 0;\n\tpadding: 0 ").concat(2.5,"% 0 ").concat(2.5,"%;\n\t").concat(vt,"\n\t").concat(kt,"\n\toverflow-y: scroll;\n\toverflow-x: auto;\n}\n.fullscreenBarLogo {\n\t").concat(e?Ve:Je,"\n}\n.fullscreenBarLogoImage {\n\tposition: relative;\n\tdisplay: block;\n\tmax-width: 80%;\n\tmax-height: 70%;\n\tmargin: auto;\n  \ttop: 50%;\n  \t-ms-transform: translateY(-50%);\n  \ttransform: translateY(-50%);\n}\n.fullscreenBarMenu {\n\t").concat(e?We:Ye,"\n}\n.fullscreenBarMenuButton {\n\tposition: relative;\n\tdisplay: ").concat(e?"block":"inline-block",";\n\t").concat(e?"width: 100%;":"top: 100%; -ms-transform: translateY(-100%); transform: translateY(-100%);","\n\tmax-height: 100%;\n\t").concat(e?function(e){return Ee(e,4,1,!0,!1)}(e):function(e){return Ee(e,1,1,!0,!1)}(e),"\n\tbox-sizing: border-box;\n\ttext-decoration: none;\n}\n.fullscreenBarMenuButton.idle {\n\t").concat(_t,"\n}\n.fullscreenBarMenuButton.selected {\n\t").concat(kt,"\n}\n.fullscreenBarMenuButton.idle:hover {\n\tcolor: ").concat(Oe,";\n}\n.fullscreenBarMenuButton.selected:hover {\n\tcolor: ").concat(Oe,";\n}\n.loadingScreen {\n\t").concat(Ne,"\n\t").concat("padding: 0 0 0 0; margin: 0 0 0 0;","\n\tz-index: 900;\n\n\t.background {\n\t\t").concat(Ne,"\n\t\t").concat("padding: 0 0 0 0; margin: 0 0 0 0;","\n\t\t").concat(gt,"\n\t}\n\t.content {\n\t\tposition: absolute;\n\t\tmin-width: 50%;\n\t\ttop: 50%;\n\t\tleft: 50%;\n\t\ttransform: translate(-50%, -50%);\n\t\t").concat(bt,"\n\t\t").concat(rt(e),"\n\t\t").concat(xt,"\n\t\ttext-align: center;\n\t\tz-index: 901;\n\t}\n}\n.popupScreen {\n\t").concat(Ne,"\n\t").concat("padding: 0 0 0 0; margin: 0 0 0 0;","\n\tz-index: 500;\n\n\t.background {\n\t\t").concat(Ne,"\n\t\t").concat("padding: 0 0 0 0; margin: 0 0 0 0;","\n\t\t").concat(It,"\n\t}\n\t.content {\n\t\tposition: absolute;\n\t\twidth: 80%;\n\t\twidth: 80%;\n\t\ttop: 50%;\n\t\tleft: 50%;\n\t\ttransform: translate(-50%, -50%);\n\t\t").concat(dt,"\n\t\t").concat(ot(e),"\n\t\t").concat(Ot,"\n\t\toverflow-y: scroll;\n\t\tz-index: 501;\n\t}\n}\n.s_image {\n\t").concat(e?function(e){return De(!1,"".concat((25-He(e)).toFixed(2),"%"))}(e):$e(e),"\n\t").concat(at(e),"\n\t").concat(vt,"\n\t").concat(Mt,"\n}\n.m_image {\n\t").concat(e?et(e):Ke(),"\n\t").concat(at(e),"\n\t").concat(vt,"\n\t").concat(Mt,"\n}\n.m_linkImage {\n\t").concat(e?et(e):De(!1,"".concat(98..toFixed(2),"%")),"\n\t").concat(at(e),"\n\t").concat(vt,"\n\t").concat(Dt,"\n}\n.m_linkImage:hover {\n\tborder-color: ").concat(Oe,";\n}\n.l_image {\n\t").concat(e?$e(e):Ke(),"\n\t").concat(at(e),"\n\t").concat(vt,"\n\t").concat(Mt,"\n}\n.portal {\n\tposition: relative;\n\tdisplay: block;\n\tmargin: ").concat(e?"5%":"12.5%"," 0;\n\tpadding: 0 0;\n\tmax-width: ").concat(e?"30%":"70%",";\n}\n.postEntryButton {\n\t").concat(Ze(),"\n\t").concat(nt(e),"\n\t").concat(ht,"\n\t").concat(Lt,"\n\ttext-decoration: none;\n}\n.postEntryButton:hover {\n\tborder-color: ").concat(Oe,";\n}\n.bigButton {\n\t").concat(Ze(),"\n\t").concat(function(e){return Ee(e,6,6)}(e),"\n\t").concat(yt,"\n\t").concat(Bt,"\n\ttext-decoration: none;\n\ttext-align: center;\n}\n.bigButton:hover {\n\tborder-color: ").concat(Oe,";\n}\n.pagePath {\n\t").concat(function(e){return Ee(e,1,1,!1,!0)}(e),"\n\t").concat(dt,"\n}\n.listScrollPanel {\n\t").concat((t="".concat(100..toFixed(2),"%"),n="".concat(70..toFixed(2),"%"),"position: relative;\n\tdisplay: ".concat("block",";\n\twidth: ").concat(t,";\n\theight: ").concat(n,";")),"\n\t").concat(nt(e),"\n\t").concat(At,"\n\toverflow: auto;\n}\n.listItem {\n\t").concat(Ze(),"\n\t").concat(nt(e),"\n\t").concat(dt,"\n\t").concat(Nt,"\n\ttext-decoration: none;\n}\n.inlineTextInput {\n\t").concat(e?tt():Ze(),"\n\t").concat(nt(e),"\n\t").concat(dt,"\n\t").concat(Ct,"\n}\n.inlineLabel {\n\t").concat(tt(),"\n\t").concat(nt(e),"\n\t").concat(dt,"\n\t").concat(kt,"\n}\n.inlineButton {\n\t").concat(tt(),"\n\t").concat(nt(e),"\n\t").concat(dt,"\n\t").concat(Lt,"\n\ttext-decoration: none;\n}\n.inlineButton:hover {\n\tborder-color: ").concat(Oe,";\n\tcursor: pointer;\n}\n.inlineButton:disabled {\n\topacity: 0.25;\n\tcursor: not-allowed;\n}\n.inlineTabButton {\n\t").concat(tt(),"\n\t").concat(nt(e),"\n\t").concat(dt,"\n\ttext-decoration: none;\n}\n.inlineTabButton.idle {\n\t").concat(jt,"\n}\n.inlineTabButton.selected {\n\t").concat(St,"\n}\n.inlineTabButton.idle:hover {\n\tcolor: ").concat(Oe,";\n}\n.inlineTabButton.selected:hover {\n\tcolor: ").concat(Oe,";\n}\n.snippet {\n\t").concat(Ze(),"\n\t").concat(ot(e),"\n\t").concat(ht,"\n\t").concat(Et,"\n\twhite-space: nowrap;\n}\n.excerpt {\n\t").concat(Xe(),"\n\t").concat(ot(e),"\n\t").concat(pt,"\n\t").concat(Ut,"\n\twhite-space: pre-wrap;\n\twhite-space: -moz-pre-wrap;\n\twhite-space: -pre-wrap;\n\twhite-space: -o-pre-wrap;\n\tword-wrap: break-word;\n}\n.zero_row {\n\t").concat(Qe(),"\n\t").concat("padding: 0 0 0 0; margin: 0 0 0 0;","\n\t").concat(wt,"\n}\n.xs_row {\n\t").concat(Qe(),"\n\t").concat(function(e){return Ee(e,.5,1)}(e),"\n\t").concat(wt,"\n}\n.s_row {\n\t").concat(Qe(),"\n\t").concat(nt(e),"\n\t").concat(wt,"\n}\n.m_row {\n\t").concat(Qe(),"\n\t").concat(ot(e),"\n\t").concat(wt,"\n}\n.l_row {\n\t").concat(Qe(),"\n\t").concat(function(e){return Ee(e,3,3)}(e),"\n\t").concat(wt,"\n}\n.xl_row {\n\t").concat(Qe(),"\n\t").concat(rt(e),"\n\t").concat(wt,"\n}\n");var t,n};const Ft="* {\n\toverflow: hidden;\n\tvertical-align: middle;\n}\nbody {\n\t".concat(Ne,"\n\t").concat("padding: 0 0 0 0; margin: 0 0 0 0;","\n\t").concat(dt,"\n\t").concat(jt,"\n\ttext-align: ").concat("left",";\n\tz-index: 0;\n}\na:link {\n  color: ").concat(xe,";\n}\na:visited {\n  color: ").concat(xe,";\n}\na:hover {\n  color: ").concat(Oe,";\n}\na:active {\n  color: ").concat(xe,";\n}\n.dim {\n\t").concat(Tt,"\n}\n.noTextDeco {\n\ttext-decoration: none;\n}\n.horizontallyCentered {\n\tleft: 50%;\n\ttransform: translate(-50%, 0);\n}\n\n@media (orientation: landscape) {\n\t").concat(Gt(!0),"\n}\n\n@media (orientation: portrait) {\n\t").concat(Gt(!1),"\n}");const qt=function(){function e(){}return e.prototype.build=function(e,t){return n=this,o=void 0,a=function(){var n,o,r,a,c,i,s;return function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,function(u){switch(u.label){case 0:return null==e&&(e="".concat(R,"/page/static/error")),null==t&&(t="".concat(T,"/error")),[4,N.getAllRelativePathsInDirRecursively(e)];case 1:n=(n=u.sent()).filter(function(e){return e.endsWith(".ejs")}),o=0,r=n,u.label=2;case 2:return o<r.length?(a=r[o],c=new ee,s=(i=c).addLine,[4,Z.createStaticHTMLFromEJS("/page/static/error/"+a,{})]):[3,6];case 3:return s.apply(i,[u.sent()]),[4,c.build(a.replace(".ejs",".html"),t)];case 4:u.sent(),u.label=5;case 5:return o++,[3,2];case 6:return[2]}})},new((r=void 0)||(r=Promise))(function(e,t){function c(e){try{s(a.next(e))}catch(e){t(e)}}function i(e){try{s(a.throw(e))}catch(e){t(e)}}function s(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r(function(e){e(n)})).then(c,i)}s((a=a.apply(n,o||[])).next())});var n,o,r,a},e}();function zt(){return e=this,t=void 0,o=function(){var e,t,n,o,r,a,c,i,s,u,l,f,d;return function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,function(p){switch(p.label){case 0:return console.log("SSG START"),e=new K,t=new $,n=new ee,r=(o=n).addLine,[4,Z.createStaticHTMLFromEJS("page/static/index.ejs",{})];case 1:return r.apply(o,[p.sent()]),[4,n.build("index.html")];case 2:return p.sent(),n=new ee,c=(a=n).addLine,[4,Z.createStaticHTMLFromEJS("page/static/portfolio.ejs",{})];case 3:return c.apply(a,[p.sent()]),[4,n.build("portfolio.html")];case 4:return p.sent(),n=new ee,s=(i=n).addLine,[4,Z.createStaticHTMLFromEJS("page/static/portfolio_minimal.ejs",{})];case 5:return s.apply(i,[p.sent()]),[4,n.build("portfolio_minimal.html")];case 6:return p.sent(),n=new ee,l=(u=n).addLine,[4,Z.createStaticHTMLFromEJS("page/static/privacyPolicy.ejs",{})];case 7:return l.apply(u,[p.sent()]),[4,n.build("privacy-policy.html")];case 8:return p.sent(),n=new ee,d=(f=n).addLine,[4,Z.createStaticHTMLFromEJS("page/static/termsOfService.ejs",{})];case 9:return d.apply(f,[p.sent()]),[4,n.build("terms-of-service.html")];case 10:return p.sent(),[4,new ae(e,t).build()];case 11:return p.sent(),[4,new he(e,t).build()];case 12:return p.sent(),[4,(new qt).build()];case 13:return p.sent(),[4,e.build()];case 14:return p.sent(),[4,t.build()];case 15:return p.sent(),[4,N.write("style.css",Ft)];case 16:return p.sent(),console.log("SSG END"),[2]}})},new((n=void 0)||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())});var e,t,n,o}const Vt=function(){function e(e,t,n,o,r,a,c,i,s,u,l,f,d){void 0===a&&(a=""),void 0===c&&(c=16),void 0===i&&(i=0),void 0===s&&(s=16),void 0===u&&(u=0),void 0===l&&(l=0),void 0===f&&(f=1),void 0===d&&(d={}),this.id=null!=e?e:"",this.userName=t,this.userType=n,this.email=o,this.tutorialStep=r,this.lastRoomID=a,this.lastX=c,this.lastY=i,this.lastZ=s,this.lastDirX=u,this.lastDirY=l,this.lastDirZ=f,this.playerMetadata=d}return e.fromString=function(t){var n=t.split(" "),o=n[0],r=n[1],a=parseInt(n[2]),c=n[3],i=parseInt(n[4]);if(isNaN(a))throw new Error('userType is NaN (userString = "'.concat(t,'")'));if(isNaN(i))throw new Error('tutorialStep is NaN (userString = "'.concat(t,'")'));return new e(o,r,a,c,i)},e.prototype.toString=function(){return"".concat(this.id," ").concat(this.userName," ").concat(this.userType," ").concat(this.email," ").concat(this.tutorialStep)},e}();const Wt=require("jsonwebtoken");var Jt=n.n(Wt),Yt="dev"==process.env.MODE;const Ht=function(){return"".concat("thingspool_token").concat(Yt?"_dev":"")},Xt=function(){return{secure:!Yt,httpOnly:!0,sameSite:"lax",maxAge:31556926e5}},Qt=function(e){try{var t=Jt().verify(e,process.env.JWT_SECRET_KEY);return t&&"string"==typeof t&&t.length>0?t:void L.log("User ID not found in the given token.",{tokenLength:e.length},"high","warn")}catch(e){return void L.log("Token Verification Failed",{err:e},"high","error")}},Zt=function(e,t,n){var o=Jt().sign(e,process.env.JWT_SECRET_KEY);null==n||n.cookie(Ht(),o,Xt()).status(201)},Kt=function(e,t){t.clearCookie(Ht(),Xt()).status(200)},$t=require("firebase-admin"),en=function(e){var t;return e instanceof Error?"Name: ".concat(e.name,", Message: ").concat(e.message,", Stack: ").concat(null!==(t=e.stack)&&void 0!==t?t:"N/A"):String(e)};var tn,nn,on=function(e,t,n,o){return new(n||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())})},rn=function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},an=!1;function cn(){return on(this,void 0,void 0,function(){var e,t,n,o;return rn(this,function(r){switch(r.label){case 0:if(an)return[2];e=$t.initializeApp({storageBucket:"thingspool.firebasestorage.app"}),tn=$t.firestore(),nn=$t.storage();try{t=function(e){var t,n={};if(!e)return"{}";if(e.projectId&&(n.projectId=e.projectId),e.storageBucket&&(n.storageBucket=e.storageBucket),e.databaseURL&&(n.databaseURL=e.databaseURL),e.serviceAccountId&&(n.serviceAccountId=e.serviceAccountId),void 0!==e.databaseAuthVariableOverride&&(n.databaseAuthVariableOverride=e.databaseAuthVariableOverride),e.httpAgent&&(n.httpAgent={constructorName:(null===(t=e.httpAgent.constructor)||void 0===t?void 0:t.name)||"Agent"}),e.credential){var o=e.credential,r={present:!0};"function"==typeof o.getAccessToken&&(r.getAccessToken=!0),o.projectId&&(r.projectId=o.projectId),o.client_email&&(r.clientEmail=o.client_email),o.private_key&&(r.privateKey="[REDACTED]"),n.credential=r}return n}(e.options),L.log("Firebase App Initialized",{options:t},"high","info")}catch(e){L.log("Failed to get Firebase app options",{errorMessage:en(e)},"high","error")}r.label=1;case 1:return r.trys.push([1,3,,4]),[4,tn.listCollections()];case 2:return n=r.sent(),L.log("Firestore collections",{count:n.length,names:n.map(function(e){return e.id})},"high","info"),[3,4];case 3:return o=r.sent(),L.log("Firestore listCollections failed",{errorMessage:en(o)},"high","error"),[3,4];case 4:return an=!0,[2]}})})}const sn=function(){return on(void 0,void 0,void 0,function(){return rn(this,function(e){switch(e.label){case 0:return[4,cn()];case 1:return e.sent(),[2,tn]}})})},un=function(){return on(void 0,void 0,void 0,function(){return rn(this,function(e){switch(e.label){case 0:return[4,cn()];case 1:return e.sent(),[2,nn]}})})},ln=[],fn=[];function dn(e,t){var n;switch(e.tableId){case O:n=ln;break;case I:n=fn;break;default:throw new Error("Unknown table ID: ".concat(e.tableId))}var o=n.length,r=t.version;if(isNaN(r))throw new Error('"version" field is not a number (tableId = '.concat(e.tableId,", docData = ").concat(JSON.stringify(t),")"));var a=r;if(a<o){for(var c=t;a<o;)(c=n[a](c)).version=++a;return c.version=a,c}return t}var pn={},hn=[];function yn(e,t){return"".concat(e,":").concat(t)}setInterval(function(){var e=Date.now();hn.length=0;for(var t=0,n=Object.entries(pn);t<n.length;t++){var o=n[t],r=o[0];e>o[1].expiry&&hn.push(r)}for(var a=0,c=hn;a<c.length;a++)r=c[a],delete pn[r]},3e4);const vn=function(e,t){var n=yn(e,t),o=pn[n];return o?Date.now()>o.expiry?(delete pn[n],null):o.data:null},mn=function(e,t,n){pn[yn(e,t)]={data:n,expiry:Date.now()+3e4}},bn=function(e,t){delete pn[yn(e,t)]};var wn=function(e,t,n,o){return new(n||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())})},gn=function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}};function xn(e,t,n){return wn(this,void 0,void 0,function(){var o,r,a,c,i,s,u,l,f,d,p,h,y=this;return gn(this,function(v){switch(v.label){case 0:return o=[],t&&(r=vn(e.tableId,e.docId))?[2,{success:!0,data:[r]}]:t?[4,t.get()]:[3,2];case 1:if((a=v.sent()).exists){if(!(c=a.data()))return L.log("DB Query Failed - doc.data() not found (docId = ".concat(a.id,")"),e.getStateAsObject(),"high","error"),[2,{success:!1,data:[]}];c.id=a.id,i=c.version,(s=dn(e,c)).version!==i&&t.firestore.runTransaction(function(e){return wn(y,void 0,void 0,function(){var n,o;return gn(this,function(r){switch(r.label){case 0:return[4,e.get(t)];case 1:return(n=r.sent()).exists&&(null===(o=n.data())||void 0===o?void 0:o.version)===i&&e.set(t,s,{merge:!1}),[2]}})})}).catch(function(e){return L.log("Migration write-back failed",{err:e},"low","error")}),o.push(s)}return[3,4];case 2:return[4,n.get()];case 3:u=v.sent(),l=u.docs,f=[],l.forEach(function(t){if(t.exists){var n=t.data();if(!n)return void L.log("DB Query Failed - doc.data() not found (docId = ".concat(t.id,")"),e.getStateAsObject(),"high","error");n.id=t.id;var r=n.version,a=dn(e,n);a.version!==r&&f.push({ref:t.ref,originalVersion:r,newDocData:a}),o.push(a)}}),f.length>0&&n.firestore.runTransaction(function(e){return wn(y,void 0,void 0,function(){var t,n,o,r,a;return gn(this,function(c){switch(c.label){case 0:t=0,n=f,c.label=1;case 1:return t<n.length?(o=n[t],[4,e.get(o.ref)]):[3,4];case 2:(r=c.sent()).exists&&(null===(a=r.data())||void 0===a?void 0:a.version)===o.originalVersion&&e.set(o.ref,o.newDocData,{merge:!1}),c.label=3;case 3:return t++,[3,1];case 4:return[2]}})})}).catch(function(e){return L.log("Migration write-back failed",{err:e},"low","error")}),v.label=4;case 4:for(d=0,p=o;d<p.length;d++)(h=p[d]).id&&"string"==typeof h.id&&mn(e.tableId,h.id,h);return L.log("DB Query Succeeded",e.getStateAsObject(),"medium"),[2,{success:!0,data:o}]}})})}function In(e,t){return n=this,o=void 0,a=function(){var n;return function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,function(o){switch(o.label){case 0:return[4,t.add(e.columnValues)];case 1:return n=o.sent(),L.log("DB Query Succeeded",e.getStateAsObject(),"medium"),[2,{success:!0,data:[{id:n.id}]}]}})},new((r=void 0)||(r=Promise))(function(e,t){function c(e){try{s(a.next(e))}catch(e){t(e)}}function i(e){try{s(a.throw(e))}catch(e){t(e)}}function s(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r(function(e){e(n)})).then(c,i)}s((a=a.apply(n,o||[])).next())});var n,o,r,a}function On(e,t,n){return o=this,r=void 0,c=function(){var o,r,a,c,i,s,u,l,f,d;return function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,function(p){switch(p.label){case 0:return o=0,t?(e._skipCacheInvalidation||bn(e.tableId,t.id),[4,t.get()]):[3,8];case 1:return(u=p.sent()).exists?(l=u.data())?(f=l.version,(d=dn(e,l)).version==f?[3,3]:(Object.assign(d,e.columnValues),[4,t.set(d,{merge:!1})])):(L.log("DB Query Failed - doc.data() not found (docId = ".concat(u.id,")"),e.getStateAsObject(),"high","error"),[2,{success:!1,data:[]}]):[3,6];case 2:return p.sent(),[3,5];case 3:return[4,t.update(e.columnValues)];case 4:p.sent(),p.label=5;case 5:return o=1,[3,7];case 6:return L.log("DB Query Failed - doc doesn't exist (docRef.id = ".concat(t.id,")"),e.getStateAsObject(),"high","error"),[2,{success:!1,data:[]}];case 7:return[3,15];case 8:return[4,n.get()];case 9:if(r=p.sent(),o=r.docs.length,!e._skipCacheInvalidation)for(a=0,c=r.docs;a<c.length;a++)u=c[a],bn(e.tableId,u.id);return r.docs.length>1?[4,sn()]:[3,12];case 10:return i=p.sent(),s=i.batch(),r.docs.forEach(function(t){var n=t.data(),o=n.version,r=dn(e,n);r.version!=o?(Object.assign(r,e.columnValues),s.set(t.ref,r,{merge:!1})):s.update(t.ref,e.columnValues)}),[4,s.commit()];case 11:return p.sent(),[3,15];case 12:return 1!=r.docs.length?[3,15]:(u=r.docs[0],l=u.data(),f=l.version,(d=dn(e,l)).version==f?[3,13]:(Object.assign(d,e.columnValues),u.ref.set(d,{merge:!1}),[3,15]));case 13:return[4,u.ref.update(e.columnValues)];case 14:p.sent(),p.label=15;case 15:return L.log("DB Query Succeeded (numDocsAffected = ".concat(o,")"),e.getStateAsObject(),"medium"),[2,{success:!0,data:[]}]}})},new((a=void 0)||(a=Promise))(function(e,t){function n(e){try{s(c.next(e))}catch(e){t(e)}}function i(e){try{s(c.throw(e))}catch(e){t(e)}}function s(t){var o;t.done?e(t.value):(o=t.value,o instanceof a?o:new a(function(e){e(o)})).then(n,i)}s((c=c.apply(o,r||[])).next())});var o,r,a,c}function jn(e,t,n){return o=this,r=void 0,c=function(){var o,r,a,c,i,s,u;return function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,function(l){switch(l.label){case 0:return o=0,t?(e._skipCacheInvalidation||bn(e.tableId,t.id),[4,t.delete(e.columnValues)]):[3,2];case 1:return l.sent(),o=1,[3,8];case 2:return[4,n.get()];case 3:if(r=l.sent(),o=r.docs.length,!e._skipCacheInvalidation)for(a=0,c=r.docs;a<c.length;a++)i=c[a],bn(e.tableId,i.id);return r.docs.length>1?[4,sn()]:[3,6];case 4:return s=l.sent(),u=s.batch(),r.docs.forEach(function(e){u.delete(e.ref)}),[4,u.commit()];case 5:return l.sent(),[3,8];case 6:return 1!=r.docs.length?[3,8]:[4,r.docs[0].ref.delete()];case 7:l.sent(),l.label=8;case 8:return L.log("DB Query Succeeded (numDocsAffected = ".concat(o,")"),e.getStateAsObject(),"medium"),[2,{success:!0,data:[]}]}})},new((a=void 0)||(a=Promise))(function(e,t){function n(e){try{s(c.next(e))}catch(e){t(e)}}function i(e){try{s(c.throw(e))}catch(e){t(e)}}function s(t){var o;t.done?e(t.value):(o=t.value,o instanceof a?o:new a(function(e){e(o)})).then(n,i)}s((c=c.apply(o,r||[])).next())});var o,r,a,c}function Sn(e){return t=this,n=void 0,r=function(){var t,n,o,r,a,c,i,s,u,l;return function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,function(f){switch(f.label){case 0:return f.trys.push([0,6,,7]),[4,sn()];case 1:t=f.sent(),n=500,o=0,f.label=2;case 2:if(!(o<e.length))return[3,5];for(r=t.batch(),a=e.slice(o,o+n),c=0,i=a;c<i.length;c++){if(!(s=i[c]).docId)throw new Error("runQueryBatch :: Each query must target a specific document (where id == ...).");switch(s._skipCacheInvalidation||bn(s.tableId,s.docId),u=t.collection(s.tableId).doc(s.docId),s.type){case"update":r.update(u,s.columnValues);break;case"delete":r.delete(u);break;default:throw new Error('runQueryBatch :: Unsupported query type "'.concat(s.type,'". Only "update" and "delete" are supported.'))}}return[4,r.commit()];case 3:f.sent(),f.label=4;case 4:return o+=n,[3,2];case 5:return L.log("DB Batch Query Succeeded (numQueries = ".concat(e.length,")"),{},"medium"),[2,{success:!0,data:[]}];case 6:return l=f.sent(),L.log("DB Batch Query Error",{errorMessage:en(l)},"high","error"),[2,{success:!1,data:[]}];case 7:return[2]}})},new((o=void 0)||(o=Promise))(function(e,a){function c(e){try{s(r.next(e))}catch(e){a(e)}}function i(e){try{s(r.throw(e))}catch(e){a(e)}}function s(t){var n;t.done?e(t.value):(n=t.value,n instanceof o?n:new o(function(e){e(n)})).then(c,i)}s((r=r.apply(t,n||[])).next())});var t,n,o,r}var kn=0,_n=Date.now();const Tn=function(e){var t=Date.now();return t-_n>=6e4&&(kn=0,_n=t),++kn>300&&"select"!==e?(L.log("DB query rate CRITICAL — write query rejected",{queryCount:kn,queryType:e},"high","error"),!1):(150===kn&&L.log("DB query rate WARNING — approaching limit",{queryCount:kn},"high","warn"),!0)};var Rn=function(e,t,n,o){return new(n||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())})},Pn=function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},Dn=function(){function e(){this.type="?",this.tableId="",this.columnValues={},this.condGroups=[[]],this._skipCacheInvalidation=!1}return e.prototype.select=function(){if("?"!=this.type)throw new Error("DB query syntax error: Query type is already determined (".concat(this.type,")"));return this.type="select",this},e.prototype.insertInto=function(e){if("?"!=this.type)throw new Error("DB query syntax error: Query type is already determined (".concat(this.type,")"));return this.type="insert",this.tableId=e,this},e.prototype.delete=function(){if("?"!=this.type)throw new Error("DB query syntax error: Query type is already determined (".concat(this.type,")"));return this.type="delete",this},e.prototype.update=function(e){if("?"!=this.type)throw new Error("DB query syntax error: Query type is already determined (".concat(this.type,")"));return this.type="update",this.tableId=e,this},e.prototype.from=function(e){if("select"!=this.type&&"delete"!=this.type)throw new Error('DB query syntax error: "from" can only appear in a "select" or "delete" query.');return this.tableId=e,this},e.prototype.set=function(e){if("update"!=this.type)throw new Error('DB query syntax error: Cannot "set" values in a non-update query.');return this.columnValues=e,this},e.prototype.values=function(e){if("insert"!=this.type)throw new Error('DB query syntax error: Cannot specify "values" in a non-insert query.');return this.columnValues=e,this},e.prototype.where=function(e,t,n){if("?"==this.type)throw new Error('DB query syntax error: "where" should not precede "select", "insert", "update", or "delete".');return"id"==e&&"=="==t?this.docId=n:this.condGroups[this.condGroups.length-1].push($t.firestore.Filter.where(e,t,n)),this},e.prototype.or=function(){return this.condGroups.push([]),this},e.prototype.orderBy=function(e,t){if(void 0===t&&(t="asc"),"select"!=this.type)throw new Error('DB query syntax error: "orderBy" can only appear in a "select" query.');return this.orderByCommand={columnName:e,direction:t},this},e.prototype.limit=function(e){if("select"!=this.type)throw new Error('DB query syntax error: "limit" can only appear in a "select" query.');return this.limitCommand=e,this},e.prototype.offset=function(e){if("select"!=this.type)throw new Error('DB query syntax error: "offset" can only appear in a "select" query.');return this.offsetCommand=e,this},e.prototype.noInvalidate=function(){return this._skipCacheInvalidation=!0,this},e.prototype.run=function(){return Rn(this,void 0,void 0,function(){var e,t,n,o,r,a,c;return Pn(this,function(i){switch(i.label){case 0:if(L.log("DB Query Started",this.getStateAsObject(),"low"),!Tn(this.type))return[2,{success:!1,data:[]}];i.label=1;case 1:return i.trys.push([1,13,,14]),[4,sn()];case 2:switch(e=i.sent(),t=e.collection(this.tableId),n=this.docId?t.doc(this.docId):void 0,o=this.condGroups[0].length>0?t.where(1==this.condGroups.length?1==this.condGroups[0].length?this.condGroups[0][0]:(a=$t.firestore.Filter).and.apply(a,this.condGroups[0]):(c=$t.firestore.Filter).or.apply(c,this.condGroups.map(function(e){var t;return 1==e.length?e[0]:(t=$t.firestore.Filter).and.apply(t,e)}))):t,this.orderByCommand&&(o=o.orderBy(this.orderByCommand.columnName,this.orderByCommand.direction)),this.limitCommand&&(o=o.limit(this.limitCommand)),this.offsetCommand&&(o=o.offset(this.offsetCommand)),this.type){case"select":return[3,3];case"insert":return[3,5];case"update":return[3,7];case"delete":return[3,9]}return[3,11];case 3:return[4,xn(this,n,o)];case 4:return[2,i.sent()];case 5:return[4,In(this,t)];case 6:return[2,i.sent()];case 7:return[4,On(this,n,o)];case 8:return[2,i.sent()];case 9:return[4,jn(this,n,o)];case 10:return[2,i.sent()];case 11:throw new Error("Unknown query type: ".concat(this.type));case 12:return[3,14];case 13:return r=i.sent(),L.log("DB Query Error",{errorMessage:en(r)},"high","error"),[2,{success:!1,data:[]}];case 14:return[2]}})})},e.runAll=function(e){return Rn(this,void 0,void 0,function(){return Pn(this,function(t){switch(t.label){case 0:return 0===e.length?[2,{success:!0,data:[]}]:[4,Sn(e)];case 1:return[2,t.sent()]}})})},e.prototype.getStateAsObject=function(){return{type:this.type,tableId:this.tableId,columnValues:this.columnValues,conditions:this.condGroups.map(function(e){return"(".concat(e.map(function(e){return function(e){var t=e;return"".concat(t.field," ").concat(t.operator," ").concat(t.value)}(e)}).join(" AND "),")")}).join(" OR ")}},e}();const Mn=Dn,En=require("firebase-admin/firestore");var Un=function(e,t,n,o){return new(n||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())})},Ln=function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},Bn={createUser:function(e,t,n){return Un(void 0,void 0,void 0,function(){var o;return Ln(this,function(r){switch(r.label){case 0:return L.log("DBUserUtil.createUser",{userName:e,userType:t,email:n},"low","info"),o={version:ln.length,userName:e,userType:t,email:n,tutorialStep:0,lastRoomID:"",lastX:16,lastY:0,lastZ:16,lastDirX:0,lastDirY:0,lastDirZ:1,playerMetadata:{},lastLoginAt:Date.now(),createdAt:Date.now(),loginCount:0,totalPlaytimeMs:0},[4,(new Mn).insertInto(O).values(o).run()];case 1:return[2,r.sent()]}})})},findUserById:function(e){return Un(void 0,void 0,void 0,function(){var t;return Ln(this,function(n){switch(n.label){case 0:return L.log("DBUserUtil.findUserById",{userID:e},"low","info"),[4,(new Mn).select().from(O).where("id","==",e).run()];case 1:return(t=n.sent()).success&&0!=t.data.length?[2,t.data[0]]:[2,null]}})})},setUserTutorialStep:function(e,t){return Un(void 0,void 0,void 0,function(){return Ln(this,function(n){switch(n.label){case 0:return L.log("DBUserUtil.setUserTutorialStep",{userId:e,tutorialStep:t},"low","info"),[4,(new Mn).update(O).set({tutorialStep:t}).where("id","==",e).run()];case 1:return[2,n.sent()]}})})},saveUserGameplayState:function(e){return Un(void 0,void 0,void 0,function(){var t;return Ln(this,function(n){switch(n.label){case 0:return L.log("DBUserUtil.saveUserGameplayState",e,"low","info"),t={lastRoomID:e.lastRoomID,lastX:e.lastX,lastY:e.lastY,lastZ:e.lastZ,lastDirX:e.lastDirX,lastDirY:e.lastDirY,lastDirZ:e.lastDirZ,playerMetadata:e.playerMetadata},null!=e.sessionDurationMs&&(t.totalPlaytimeMs=En.FieldValue.increment(e.sessionDurationMs)),[4,(new Mn).update(O).set(t).where("id","==",e.userID).run()];case 1:return[2,n.sent()]}})})},saveMultipleUsersGameplayState:function(e){return Un(void 0,void 0,void 0,function(){var t;return Ln(this,function(n){switch(n.label){case 0:return 0==e.length?[2]:(L.log("DBUserUtil.saveMultipleUsersGameplayState",{count:e.length},"low","info"),t=e.map(function(e){var t={lastRoomID:e.lastRoomID,lastX:e.lastX,lastY:e.lastY,lastZ:e.lastZ,lastDirX:e.lastDirX,lastDirY:e.lastDirY,lastDirZ:e.lastDirZ,playerMetadata:e.playerMetadata};return null!=e.sessionDurationMs&&(t.totalPlaytimeMs=En.FieldValue.increment(e.sessionDurationMs)),(new Mn).update(O).set(t).where("id","==",e.userID)}),[4,Mn.runAll(t)]);case 1:return n.sent(),[2]}})})},upgradeGuestToMember:function(e,t,n){return Un(void 0,void 0,void 0,function(){return Ln(this,function(o){switch(o.label){case 0:return L.log("DBUserUtil.upgradeGuestToMember",{userID:e,userName:t,email:n},"low","info"),[4,(new Mn).update(O).set({userName:t,userType:1,email:n}).where("id","==",e).run()];case 1:return[2,o.sent()]}})})},updateLastLogin:function(e){return Un(void 0,void 0,void 0,function(){return Ln(this,function(t){switch(t.label){case 0:return[4,(new Mn).update(O).noInvalidate().set({lastLoginAt:Date.now(),loginCount:En.FieldValue.increment(1)}).where("id","==",e).run()];case 1:return t.sent(),[2]}})})},deleteStaleGuestsByTier:function(e){return Un(void 0,void 0,void 0,function(){var t,n,o,r,a;return Ln(this,function(c){switch(c.label){case 0:return t=Date.now()-S[e],[4,(new Mn).select().from(O).where("userType","==",2).where("lastLoginAt","<",t).run()];case 1:return(n=c.sent()).success&&0!==n.data.length?(o=function(t){var n,o,r=null!==(n=t.loginCount)&&void 0!==n?n:0,a=null!==(o=t.totalPlaytimeMs)&&void 0!==o?o:0,c=0;return r>3&&a>=m?c=2:r>1&&a>=6e5&&(c=1),e==c},0===(r=n.data.filter(o)).length?[2,0]:(a=r.filter(function(e){return e.id}).map(function(e){return(new Mn).delete().from(O).where("id","==",e.id)}),[4,Mn.runAll(a)])):[2,0];case 2:return c.sent(),[2,r.length]}})})},deleteUser:function(e){return Un(void 0,void 0,void 0,function(){return Ln(this,function(t){switch(t.label){case 0:return L.log("DBUserUtil.deleteUser",{userID:e},"low","info"),[4,(new Mn).delete().from(O).where("id","==",e).run()];case 1:return[2,t.sent()]}})})},fromDBType:function(e){var t,n,o,r,a,c,i,s;return new Vt(e.id,e.userName,e.userType,e.email,e.tutorialStep,null!==(t=e.lastRoomID)&&void 0!==t?t:"",null!==(n=e.lastX)&&void 0!==n?n:16,null!==(o=e.lastY)&&void 0!==o?o:0,null!==(r=e.lastZ)&&void 0!==r?r:16,null!==(a=e.lastDirX)&&void 0!==a?a:0,null!==(c=e.lastDirY)&&void 0!==c?c:0,null!==(i=e.lastDirZ)&&void 0!==i?i:1,null!==(s=e.playerMetadata)&&void 0!==s?s:{})}};const Cn=Bn;var An=m,Nn={},Gn={},Fn=[],qn=Date.now();function zn(e,t){Fn.length=0;for(var n=0,o=Object.entries(e);n<o.length;n++){var r=o[n],a=r[0];t-r[1].windowStart>=An&&Fn.push(a)}for(var c=0,i=Fn;c<i.length;c++)delete e[a=i[c]]}function Vn(e,t,n,o){var r=e[t];return!r||o-r.windowStart>=An?(e[t]={count:1,windowStart:o},!0):!(r.count>=n||(r.count++,0))}const Wn=function(e,t){var n=Date.now();return function(e){e-qn<6e5||(qn=e,zn(Nn,e),zn(Gn,e))}(n),Vn(Nn,e,10,n)?!!Vn(Gn,t,3,n)||(L.log("Guest creation blocked (User-Agent limit)",{userAgent:t},"high","warn"),!1):(L.log("Guest creation blocked (IP limit)",{ip:e},"high","warn"),!1)};var Jn=function(e,t,n,o){return new(n||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())})},Yn=function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},Hn=0,Xn={identifyAdmin:function(e,t,n){return Jn(void 0,void 0,void 0,function(){return Yn(this,function(o){switch(o.label){case 0:return[4,Qn(e,t,function(e){return 0==e.userType},n)];case 1:return o.sent(),[2]}})})},identifyRegisteredUser:function(e,t,n){return Jn(void 0,void 0,void 0,function(){return Yn(this,function(o){switch(o.label){case 0:return[4,Qn(e,t,function(e){return 0==e.userType||1==e.userType},n)];case 1:return o.sent(),[2]}})})},identifyAnyUser:function(e,t,n){return Jn(void 0,void 0,void 0,function(){return Yn(this,function(o){switch(o.label){case 0:return[4,Qn(e,t,function(e){return!0},n)];case 1:return o.sent(),[2]}})})}};function Qn(e,t,n,o){return Jn(this,void 0,void 0,function(){var r,a;return Yn(this,function(c){switch(c.label){case 0:return c.trys.push([0,2,,3]),[4,Zn(e,t)];case 1:return(r=c.sent())?n(r)?(Zt(r.id,e,t),e.userString=r.toString(),o(),[2,!0]):(L.log("User doesn't satisfy the pass-condition.",{user:r},"high","error"),t.status(403).send("User doesn't satisfy the pass-condition."),[2,!1]):(L.logRaw("Failed to identify the user","high","error"),t.status(401).send("Failed to identify the user"),[2,!1]);case 2:return a=c.sent(),L.log("Failed to identify user",{err:a},"high","error"),t.status(401).send("Failed to identify user (error: ".concat(a,")")),[2,!1];case 3:return[2]}})})}function Zn(e,t){return Jn(this,void 0,void 0,function(){var n,o,r,a,c,i,s,u,l,f;return Yn(this,function(d){switch(d.label){case 0:return(n=e.cookies[Ht()])&&(o=Qt(n))?[4,Cn.findUserById(o)]:[3,2];case 1:if(r=d.sent())return Cn.updateLastLogin(o),[2,Cn.fromDBType(r)];d.label=2;case 2:return a=e.ip||"unknown",c=e.headers["user-agent"]||"unknown",Wn(a,c)?(i=10*(Math.floor(Date.now()/1e3)-1768e6)+Hn,Hn=(Hn+1)%10,s=i.toString(16),u="Guest-".concat(s),[4,Cn.createUser(u,2,"")]):[2,void 0];case 3:return(l=d.sent()).success&&0!=l.data.length?(f=l.data[0].id,Zt(f,e,t),[2,new Vt(f,u,2,"",0)]):(L.logRaw("Failed to create guest user in Firestore","high","error"),[2,void 0])}})})}const Kn=Xn;process.env.MODE;var $n=r().Router();$n.get("/mypage",Kn.identifyAnyUser,function(e,t){Z.render(e,t,"page/dynamic/mypage",{gitCommit:"25fc4090"})}),"dev"==process.env.MODE?($n.get("/console",function(e,t){Z.render(e,t,"page/development/console",{})}),$n.get("/test-ui",function(e,t){Z.render(e,t,"page/development/test_ui",{gameEntries:oe.gameEntries})}),$n.get("/tailwind_test",function(e,t){Z.render(e,t,"page/development/tailwind_test",{})})):$n.get("/console",Kn.identifyAdmin,function(e,t){Z.render(e,t,"page/development/console",{})});const eo=$n,to=require("url");var no=n.n(to);const oo=require("crypto");var ro=n.n(oo);const ao=require("axios");var co=n.n(ao),io=function(e,t,n,o){return new(n||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())})},so=function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}};function uo(e,t,n){return io(this,void 0,void 0,function(){var o,r,a;return so(this,function(c){switch(c.label){case 0:return c.trys.push([0,2,,3]),[4,co()[e](t,n)];case 1:return[2,{status:(o=c.sent()).status,data:o.data}];case 2:return r=c.sent(),co().isAxiosError(r)?r.response?[2,{status:r.response.status,data:r.response.data}]:[2,{status:null!==(a=r.status)&&void 0!==a?a:500,data:r.message}]:[2,{status:500,data:en(r)}];case 3:return[2]}})})}const lo=function(e,t){return io(void 0,void 0,void 0,function(){return so(this,function(n){switch(n.label){case 0:return[4,uo("get",e,t)];case 1:return[2,n.sent()]}})})},fo=function(e,t){return io(void 0,void 0,void 0,function(){return so(this,function(n){switch(n.label){case 0:return[4,uo("post",e,t)];case 1:return[2,n.sent()]}})})};var po=function(e,t,n,o){return new(n||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())})},ho=function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}};const yo={all:function(e){return po(void 0,void 0,void 0,function(){return ho(this,function(t){switch(t.label){case 0:return L.log("DBSearchUtil.rooms.all",{page:e},"low","info"),[4,(new Mn).select().from(I).orderBy("roomName").limit(10).offset(10*e).run()];case 1:return[2,t.sent()]}})})},withRoomName:function(e){return po(void 0,void 0,void 0,function(){return ho(this,function(t){switch(t.label){case 0:return L.log("DBSearchUtil.rooms.withRoomName",{roomName:e},"low","info"),[4,(new Mn).select().from(I).where("roomName","==",e).run()];case 1:return[2,t.sent()]}})})},withRoomType:function(e){return po(void 0,void 0,void 0,function(){return ho(this,function(t){switch(t.label){case 0:return L.log("DBSearchUtil.rooms.withRoomType",{roomType:e},"low","info"),[4,(new Mn).select().from(I).where("roomType","==",e).run()];case 1:return[2,t.sent()]}})})}},vo={all:function(e){return po(void 0,void 0,void 0,function(){return ho(this,function(t){switch(t.label){case 0:return L.log("DBSearchUtil.users.all",{page:e},"low","info"),[4,(new Mn).select().from(O).orderBy("userName").limit(10).offset(10*e).run()];case 1:return[2,t.sent()]}})})},withUserName:function(e){return po(void 0,void 0,void 0,function(){return ho(this,function(t){switch(t.label){case 0:return L.log("DBSearchUtil.users.withUserName",{userName:e},"low","info"),[4,(new Mn).select().from(O).where("userName","==",e).run()];case 1:return[2,t.sent()]}})})},withEmail:function(e){return po(void 0,void 0,void 0,function(){return ho(this,function(t){switch(t.label){case 0:return L.log("DBSearchUtil.users.withEmail",{email:e},"low","info"),[4,(new Mn).select().from(O).where("email","==",e).run()];case 1:return[2,t.sent()]}})})},withUserNameOrEmail:function(e,t){return po(void 0,void 0,void 0,function(){return ho(this,function(n){switch(n.label){case 0:return L.log("DBSearchUtil.users.withUserNameOrEmail",{userName:e,email:t},"low","info"),[4,(new Mn).select().from(O).where("userName","==",e).or().where("email","==",t).run()];case 1:return[2,n.sent()]}})})}};var mo=function(e,t,n,o){return new(n||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())})},bo=function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},wo={login:function(e,t){return mo(void 0,void 0,void 0,function(){return bo(this,function(e){return t.redirect("https://accounts.google.com/o/oauth2/v2/auth?client_id=".concat(go,"&response_type=code&redirect_uri=").concat(Io,"&scope=openid%20profile%20email&access_type=offline&state=").concat(ro().randomUUID(),"&prompt=consent")),[2]})})},loginCallback:function(e,t){return mo(void 0,void 0,void 0,function(){var n,o,r,a,c,i,s,u,l,f,d,p,h,y,v,m,b;return bo(this,function(w){switch(w.label){case 0:return w.trys.push([0,13,,14]),(n=no().parse(e.url,!0).query)&&n.code?[4,fo((g=n.code,"https://oauth2.googleapis.com/token?code=".concat(g,"&client_id=").concat(go,"&client_secret=").concat(xo,"&redirect_uri=").concat(Io,"&grant_type=authorization_code")))]:(t.status(400).send("Google OAuth code not found."),[2]);case 1:return(o=w.sent()).status<200||o.status>=300?(t.status(500).send("Failed to fetch the access token from Google API."),[2]):(r=o.data.access_token,[4,lo(Oo,{headers:{authorization:"Bearer ".concat(r)}})]);case 2:return(a=w.sent()).status<200||a.status>=300?(t.status(500).send("Failed to fetch the user info from Google API."),[2]):(c=a.data,(i=c.email)?(s=i.split("@")[0],u=s,[4,vo.withEmail(i)]):(t.status(404).send("Email address not found."),[2]));case 3:if(!(l=w.sent()).success)return t.status(500).send("Internal Server Error"),[2];if(f=e.cookies[Ht()],d=f?Qt(f):void 0,0!=l.data.length)return[3,11];p=!1,h=0,w.label=4;case 4:return!p&&++h<=9?(h>=2&&(u="".concat(s,"#").concat(h)),[4,vo.withUserName(u)]):[3,6];case 5:return(y=w.sent()).success?(0==y.data.length&&(p=!0),[3,4]):(t.status(500).send("Internal Server Error"),[2]);case 6:return p?d?[4,Cn.upgradeGuestToMember(d,u,i)]:[3,8]:(t.status(500).send('Username "'.concat(s,'" is used too many times.')),[2]);case 7:return w.sent(),[3,10];case 8:return[4,Cn.createUser(u,1,i)];case 9:if(!(v=w.sent()).success)return t.status(500).send("Internal Server Error (during registration)"),[2];Zt(v.data[0].id,e,t),w.label=10;case 10:return[3,12];case 11:m=l.data[0],d&&d!==m.id&&Cn.deleteUser(d),Zt(m.id,e,t),w.label=12;case 12:return t.redirect("/mypage"),[3,14];case 13:return b=w.sent(),L.log("Login Error",{err:b},"high","error"),t.status(500).send("ERROR: Failed to login (".concat(b,").")),[3,14];case 14:return[2]}var g})})}},go=process.env.GOOGLE_OAUTH_CLIENT_ID,xo=process.env.GOOGLE_OAUTH_CLIENT_SECRET,Io="".concat(W.getEnvDynamicURL(),"/").concat(b,"/login_google_callback"),Oo="https://www.googleapis.com/oauth2/v3/userinfo?alt=json";const jo=wo;var So=function(e,t,n,o){return new(n||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())})},ko=function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},_o=r().Router();_o.get("/login_google",function(e,t){return So(void 0,void 0,void 0,function(){return ko(this,function(n){switch(n.label){case 0:return[4,jo.login(e,t)];case 1:return n.sent(),t.statusCode>=200&&t.statusCode<=299&&t.end(),[2]}})})}),_o.get("/login_google_callback",function(e,t){return So(void 0,void 0,void 0,function(){return ko(this,function(n){switch(n.label){case 0:return[4,jo.loginCallback(e,t)];case 1:return n.sent(),t.statusCode>=200&&t.statusCode<=299&&t.redirect(W.getMyPageURL()),[2]}})})}),_o.post("/logout",function(e,t){Kt(e,t),t.statusCode>=200&&t.statusCode<=299&&t.end()});const To=_o,Ro=require("express-rate-limit");var Po=n.n(Ro);const Do={pageRateLimiter:Po()({windowMs:6e4,limit:20,standardHeaders:!0,legacyHeaders:!1,message:"Too many requests. Please try again later.",handler:function(e,t,n,o){L.log("Page rate limit exceeded",{ip:e.ip,path:e.path},"high","warn"),t.status(o.statusCode).send(o.message)}}),apiRateLimiter:Po()({windowMs:6e4,limit:20,standardHeaders:!0,legacyHeaders:!1,message:"Too many requests. Please try again later.",handler:function(e,t,n,o){L.log("API rate limit exceeded",{ip:e.ip,path:e.path},"high","warn"),t.status(o.statusCode).send(o.message)}})};var Mo=function(e,t,n,o){return new(n||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())})},Eo=function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}};const Uo=require("socket.io");var Lo,Bo=n.n(Uo),Co="</td>",Ao={init:function(e,t){(Lo=e.of("/console_sockets")).use(t),Lo.on("connection",function(e){console.log("(ConsoleSockets) Client connected :: ".concat(JSON.stringify(e.handshake.auth))),e.on("command",function(t){console.log("(ConsoleSockets) Command received :: [".concat(t,"] - sent by :: ").concat(JSON.stringify(e.handshake.auth.user)));var n=t.split(" ");switch(n[0]){case"print":n.shift(),L.logRaw(0==n.length?"-":n.join(" "),"high");break;case"reboot":L.logRaw("Rebooting...","high"),process.exit(0);break;default:L.logRaw('Unknown command "'.concat(n[0],'".'),"high","error")}}),e.on("disconnect",function(){console.log("(ConsoleSockets) Client disconnected :: ".concat(JSON.stringify(e.handshake.auth))),M.removeListener("consoleSocket_".concat(e.id))}),M.addListener("consoleSocket_".concat(e.id),Ao.log)})},log:function(e){var t,n,o=e.eventTitle;switch(e.logType){case"info":break;case"warn":o='<b style="color:yellow">'.concat(o,"</b>");break;case"error":o='<b style="color:pink">'.concat(o,"</b>");break;default:throw new Error("Unknown log type: ".concat(e.logType))}null==Lo||Lo.emit("log",(t=o,n=e.eventDescJSON,"".concat('<td style="color: #e0e020; background-color: #202090;">').concat(t).concat(Co).concat('<td style="color: #303030; background-color: #c0c0c0;">').concat(n).concat(Co)))}};const No=Ao,Go=function(){function e(){}return e.decode=function(e){throw new Error("'decode' method is not implemented.")},e}();var Fo,qo=(Fo=function(e,t){return Fo=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},Fo(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}Fo(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});const zo=function(e){function t(t){var n=e.call(this)||this;return n.str=t,n}return qo(t,e),t.prototype.encode=function(e){for(var t=0;t<this.str.length;++t){var n=this.str.charCodeAt(t);(n<0||n>255)&&(console.error("Char code is out of the 8-bit range (code = ".concat(n,", string = ").concat(this.str,", index = ").concat(t,")")),n="?".charCodeAt(0)),e.view[e.byteIndex++]=n}e.view[e.byteIndex++]=0},t.decode=function(e){for(var n,o=[];e.byteIndex<e.view.length&&0!=(n=e.view[e.byteIndex++]);)o.push(String.fromCharCode(n));return new t(o.join(""))},t}(Go);var Vo=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const Wo=function(e){function t(t,n){var o=e.call(this)||this;return o.senderObjectId=t,o.message=n,o}return Vo(t,e),t.prototype.encode=function(e){new zo(this.senderObjectId).encode(e),new zo(this.message).encode(e)},t.decode=function(e){return new t(zo.decode(e).str,zo.decode(e).str)},t}(Go);var Jo={normalizeInRange:function(e,t,n){return(Jo.clampInRange(e,t,n)-t)/(n-t)},clampInRange:function(e,t,n){return Math.max(t,Math.min(n,e))},normalizeInRangeWithWarning:function(e,t,n){return(Jo.clampInRangeWithWarning(e,t,n)-t)/(n-t)},clampInRangeWithWarning:function(e,t,n){return(e<t||e>n)&&console.warn("'n' is out of its expected range (n = ".concat(e,", min = ").concat(t,", max = ").concat(n,")")),Math.max(t,Math.min(n,e))}};const Yo=Jo;var Ho=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Xo=0,Qo=0;const Zo=function(e){function t(t,n,o){var r=e.call(this)||this;return r.n=t,r.min=n,r.max=o,r}return Ho(t,e),t.prototype.encode=function(e){e.view[e.byteIndex++]=Math.floor(255.9999*Yo.normalizeInRangeWithWarning(this.n,this.min,this.max))},t.decodeWithParams=function(e,n,o){return Xo=n,Qo=o,t.decode(e)},t.decode=function(e){return new t(Xo+e.view[e.byteIndex++]*(Qo-Xo)/255.9999,Xo,Qo)},t}(Go);var Ko=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),$o=[0,32],er=[-1,4.019605882352941],tr=[-1,1.0157472440944881];const nr=function(e){function t(t,n,o,r,a,c){var i=e.call(this)||this;return i.x=t,i.y=n,i.z=o,i.dirX=r,i.dirY=a,i.dirZ=c,i}return Ko(t,e),t.prototype.encode=function(e){new Zo(this.x,$o[0],$o[1]).encode(e),new Zo(this.y,er[0],er[1]).encode(e),new Zo(this.z,$o[0],$o[1]).encode(e),new Zo(this.dirX,tr[0],tr[1]).encode(e),new Zo(this.dirY,tr[0],tr[1]).encode(e),new Zo(this.dirZ,tr[0],tr[1]).encode(e)},t.decode=function(e){return new t(Zo.decodeWithParams(e,$o[0],$o[1]).n,Zo.decodeWithParams(e,er[0],er[1]).n,Zo.decodeWithParams(e,$o[0],$o[1]).n,Zo.decodeWithParams(e,tr[0],tr[1]).n,Zo.decodeWithParams(e,tr[0],tr[1]).n,Zo.decodeWithParams(e,tr[0],tr[1]).n)},t}(Go);var or=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const rr=function(e){function t(t,n){var o=e.call(this)||this;return o.objectId=t,o.transform=n,o}return or(t,e),t.prototype.encode=function(e){new zo(this.objectId).encode(e),this.transform.encode(e)},t.decode=function(e){return new t(zo.decode(e).str,nr.decode(e))},t}(Go);var ar=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const cr=function(e){function t(t){var n=e.call(this)||this;return n.roomID=t,n}return ar(t,e),t.prototype.encode=function(e){new zo(this.roomID).encode(e)},t.decode=function(e){return new t(zo.decode(e).str)},t}(Go),ir=function(e){var t=Math.sqrt(e.x*e.x+e.y*e.y);if(0==t)return{x:0,y:0};var n=1/t;return{x:e.x*n,y:e.y*n}},sr=function(e,t){return{x:e.x*t,y:e.y*t}},ur=function(e,t){return{x:e.x+t.x,y:e.y+t.y}},lr=function(e,t){return{x:e.x-t.x,y:e.y-t.y}},fr=function(e,t){return e.x*t.y-e.y*t.x},dr=function(e,t){return e.x*t.x+e.y*t.y},pr=function(e,t){var n=t.x-e.x,o=t.y-e.y;return n*n+o*o};var hr=new Array;function yr(e,t){hr.length=0;for(var n=Math.max(0,Math.floor(t.y-t.halfSizeY)),o=Math.max(0,Math.floor(t.x-t.halfSizeX)),r=Math.min(31,Math.floor(t.y+t.halfSizeY)),a=Math.min(31,Math.floor(t.x+t.halfSizeX)),c=n;c<=r;++c)for(var i=o;i<=a;++i){var s=e.voxels[c*w+i];null!=s?hr.push(s):console.error("PhysicsVoxel is undefined (row = ".concat(c,", col = ").concat(i,")"))}return hr}var vr=new Array,mr=new Array;function br(e,t){for(var n=!1,o=0;o<t.intersectingObjects.length;++o)t.intersectingObjects[o].objectId==e.objectId&&(console.error("Object already added to voxel (object = ".concat(JSON.stringify(e),", voxel = ").concat(JSON.stringify(t),")")),n=!0);for(n||t.intersectingObjects.push(e),n=!1,o=0;o<e.intersectingVoxels.length;++o)e.intersectingVoxels[o]==t&&(console.error("Voxel already added to object (object = ".concat(JSON.stringify(e),", voxel = ").concat(JSON.stringify(t),")")),n=!0);n||e.intersectingVoxels.push(t)}function wr(e){vr.length=0;for(var t=0,n=e.intersectingVoxels;t<n.length;t++){var o=n[t];vr.push(o)}for(var r=0,a=vr;r<a.length;r++)gr(e,o=a[r])}function gr(e,t){for(var n=!1,o=t.intersectingObjects,r=0;r<o.length;++r)if(o[r].objectId==e.objectId){for(var a=r+1;a<o.length;++a)o[r]=o[a];--o.length,n=!0}n||console.error("Object not found in voxel (object = ".concat(JSON.stringify(e),", voxel = ").concat(JSON.stringify(t),")"))}var xr={castAABBAgainstAABB:function(e,t,n){var o,r,a=n.x-n.halfSizeX-e.halfSizeX,c=n.y-n.halfSizeY-e.halfSizeY,i=n.x+n.halfSizeX+e.halfSizeX,s=n.y+n.halfSizeY+e.halfSizeY,u={x:a,y:c},l={x:i,y:c},f={x:a,y:s},d={x:i,y:s},p={start:u,end:l},h={start:l,end:d},y={start:d,end:f},v={start:f,end:u},m={start:{x:e.x,y:e.y},end:t},b=1;return(o=Math.min(b,xr.raycastToLine(m,p,!0)))<b&&(b=o,r=p),(o=Math.min(b,xr.raycastToLine(m,h,!0)))<b&&(b=o,r=h),(o=Math.min(b,xr.raycastToLine(m,y,!0)))<b&&(b=o,r=y),(o=Math.min(b,xr.raycastToLine(m,v,!0)))<b&&(b=o,r=v),{hitRayScale:b,hitLine:r}},raycastToLine:function(e,t,n){void 0===n&&(n=!1);var o=lr(e.end,e.start),r=lr(t.end,t.start),a=fr(o,r);if(0==a)return 1;if(n&&a>0)return 1;var c=1/a,i=lr(t.start,e.start),s=fr(i,r)*c,u=fr(i,o)*c;return s<0||s>1||u<0||u>1?1:s}};const Ir=xr;function Or(e,t,n,o){var r=Ir.castAABBAgainstAABB(e,t,n);return r.hitRayScale<=o.minHitRayScale&&(o.minHitRayScale=r.hitRayScale,o.hitLine=r.hitLine),o}function jr(e,t,n){if(t<0||t>=32||n<0||n>=w)throw new Error("Voxel coordinates are out of range (row: ".concat(t,", col: ").concat(n,")"));return e.voxelGrid.voxels[t*w+n]}function Sr(e,t){return t<0||t>7||!!(e.collisionLayerMask&1<<t)}function kr(e){for(var t=7,n=e.collisionLayerMask;!(128&n);){if(0==(n<<=1))return 8;t--}return t}function _r(e,t,n,o,r){var a=Tr(e,t,r),c=Pr(n,o);return c>=6?-1:a+c}function Tr(e,t,n){return Rr(e,t)+6*n}function Rr(e,t){return g*(e*w+t)}function Pr(e,t){return 2*("y"==e?0:"x"==e?1:2)+("-"==t?0:1)}function Dr(e){var t=Math.floor(e%g%6*.5);return 0==t?"y":1==t?"x":"z"}function Mr(e){return e%2==0?"-":"+"}function Er(e){return Math.floor(e%g/6)}function Ur(e){var t=Math.floor(e/g);return Math.floor(t/w)}function Lr(e){return Math.floor(e/g)%w}var Br={},Cr={minHitRayScale:1,hitLine:void 0};const Ar={load:function(e){if(null!=Br[e.room.id])throw new Error("Physics-room already exists (roomID = ".concat(e.room.id,")"));var t=e.room.voxelGrid;Br[e.room.id]={room:e.room,voxels:t.voxels.map(function(e){var t=e.row,n=e.col,o=new Array(4);return o.length=0,{voxel:e,hitbox:{x:n+.5,y:t+.5,halfSizeX:.5,halfSizeY:.5},intersectingObjects:o}}),objectById:{}}},unload:function(e){if(null==Br[e])throw new Error("Physics-room doesn't exist (roomID = ".concat(e,")"));delete Br[e]},hasRoom:function(e){return null!=Br[e]},addObject:function(e,t,n,o,r){var a=Br[e];if(null==a)throw new Error("Physics-room doesn't exist (roomID = ".concat(e,", objectId = ").concat(t,")"));if(null!=a.objectById[t])return console.warn("PhysicsObjct is already added (roomID = ".concat(e,", objectId = ").concat(t,")")),a.objectById[t];var c=new Array(4);c.length=0;var i={objectId:t,collisionLayerMaskAtGroundLevel:r,level:Math.round(2*n),lastLevelChangeTime:.001*performance.now(),hitbox:o,intersectingVoxels:c};return a.objectById[t]=i,function(e,t,n){var o=e.objectById[t];if(null==o)throw new Error("PhysicsObject is not registered (objectId = ".concat(t,")"));var r=yr(e,o.hitbox);o.hitbox.x=n.x,o.hitbox.y=n.y,wr(o);for(var a=0,c=r;a<c.length;a++)br(o,c[a])}(a,t,{x:o.x,y:o.y}),i},removeObject:function(e,t){var n=Br[e];if(null==n)throw new Error("Physics-room doesn't exist (roomID = ".concat(e,", objectId = ").concat(t,")"));var o=n.objectById[t];if(null==o)throw new Error("PhysicsObject is not registered (roomID = ".concat(e,", objectId = ").concat(t,")"));delete n.objectById[t],wr(o)},tryMoveObject:function(e,t,n){var o=Br[e];if(null==Br[e])throw new Error("Physics-room doesn't exist (roomID = ".concat(e,")"));var r=o.objectById[t];if(null==r)throw new Error("PhysicsObject is not registered (objectId = ".concat(t,")"));var a={x:r.hitbox.x,y:r.hitbox.y},c=pr(n,a);if(c>=9)return console.warn("Physics-position desync due to distance gap (startPos = (".concat(a.x.toFixed(3),", ").concat(a.y.toFixed(3),"), targetPos = (").concat(n.x.toFixed(3),", ").concat(n.y.toFixed(3),"), dist = ").concat(Math.sqrt(c),")")),{resolvedPos:a,desyncDetected:!0};var i=ir(lr(n,a));a=lr(a,sr(i,.01));var s=Math.min(a.x,n.x)-r.hitbox.halfSizeX,u=Math.max(a.x,n.x)+r.hitbox.halfSizeX,l=Math.min(a.y,n.y)-r.hitbox.halfSizeY,f=Math.max(a.y,n.y)+r.hitbox.halfSizeY,d=Math.floor(s),p=Math.floor(u),h=Math.floor(l),y=Math.floor(f);if(d<0||h<0||p>=w||y>=32)return console.warn("Physics-position desync due to room boundary limit (startPos = (".concat(a.x.toFixed(3),", ").concat(a.y.toFixed(3),"), targetPos = (").concat(n.x.toFixed(3),", ").concat(n.y.toFixed(3),", minCol = ").concat(d,", minRow = ").concat(h,", maxCol = ").concat(p,", maxRow = ").concat(y,"))")),{resolvedPos:a,desyncDetected:!0};Cr.minHitRayScale=1,Cr.hitLine=void 0;for(var v=.001*performance.now(),m=o.voxels[Math.floor(a.y)*w+Math.floor(a.x)].voxel,b=r.collisionLayerMaskAtGroundLevel<<r.level,g=r.collisionLayerMaskAtGroundLevel<<r.level+1,x=-9999,I=h;I<=y;++I)for(var O=d;O<=p;++O){var j=(F=o.voxels[I*w+O]).voxel;0!=(j.collisionLayerMask&b)&&(v>=r.lastLevelChangeTime+.2&&!(128&b)&&0==(m.collisionLayerMask&g)&&0==(j.collisionLayerMask&g)?(r.level++,b=r.collisionLayerMaskAtGroundLevel<<r.level,r.lastLevelChangeTime=v):Or(r.hitbox,n,F.hitbox,Cr));var S=kr(j);8!=S&&S>x&&(x=S)}r.level>0&&v>=r.lastLevelChangeTime+.2&&function(e){for(var t=0,n=e.collisionLayerMaskAtGroundLevel<<e.level;!(1&n);){if(0==(n>>=1))return 8;t++}return t}(r)>x+1&&(r.level--,b=r.collisionLayerMaskAtGroundLevel<<r.level,r.lastLevelChangeTime=v);for(var k=0,_=Object.values(o.objectById);k<_.length;k++){var T=_[k],R=T.collisionLayerMaskAtGroundLevel<<T.level;r.objectId!=T.objectId&&(r.hitbox.halfSizeX>0||r.hitbox.halfSizeY>0)&&0!=(b&R)&&(Cr=Or(r.hitbox,n,T.hitbox,Cr))}var P=n;if(null!=Cr.hitLine){var D=sr(lr(n,a),Cr.minHitRayScale),M=ur(a,D),E=lr(n,M),U=lr(Cr.hitLine.end,Cr.hitLine.start),L=dr(E,U);L<0&&(U=lr(Cr.hitLine.start,Cr.hitLine.end),L=dr(E,U));for(var B=sr(U,L/dr(U,U)),C=ur(M,B),A=!1,N=0,G=yr(o,{x:C.x,y:C.y,halfSizeX:r.hitbox.halfSizeX,halfSizeY:r.hitbox.halfSizeY});N<G.length;N++){var F;0!=((F=G[N]).voxel.collisionLayerMask&b)&&(A=!0)}P=A?M:C}return r.hitbox.x=P.x,r.hitbox.y=P.y,{resolvedPos:P,desyncDetected:!1}},forceMoveObject:function(e,t,n){var o=Br[e];if(null==Br[e])throw new Error("Physics-room doesn't exist (roomID = ".concat(e,")"));var r=o.objectById[t];if(null==r)throw new Error("PhysicsObject is not registered (objectId = ".concat(t,")"));r.hitbox.x=n.x,r.hitbox.y=n.y},getObjectsInDist:function(e,t,n,o){var r=Br[e];if(null==Br[e])throw new Error("Physics-room doesn't exist (roomID = ".concat(e,")"));return function(e,t,n,o){var r=yr(e,{x:t,y:n,halfSizeX:o,halfSizeY:o});mr.length=0;for(var a=0,c=r;a<c.length;a++)for(var i=0,s=c[a].intersectingObjects;i<s.length;i++){var u=s[i],l=u.hitbox.x-t,f=u.hitbox.y-n;l*l+f*f<=o*o&&mr.push(u)}return mr}(r,t,n,o)}};var Nr=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Gr=0,Fr=0;const qr=function(e){function t(t,n,o){var r=e.call(this)||this;return r.v=t,r.min=n,r.max=o,r}return Nr(t,e),t.prototype.encode=function(e){new Zo(this.v.x,this.min,this.max).encode(e),new Zo(this.v.y,this.min,this.max).encode(e)},t.decodeWithParams=function(e,n,o){return Gr=n,Fr=o,t.decode(e)},t.decode=function(e){var n=Zo.decodeWithParams(e,Gr,Fr),o=Zo.decodeWithParams(e,Gr,Fr);return new t({x:n.n,y:o.n},Gr,Fr)},t}(Go);var zr=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const Vr=function(e){function t(t,n){var o=e.call(this)||this;return o.objectId=t,o.resolvedPos=n,o}return zr(t,e),t.prototype.encode=function(e){new zo(this.objectId).encode(e),new qr(this.resolvedPos,0,32).encode(e)},t.decode=function(e){return new t(zo.decode(e).str,qr.decodeWithParams(e,0,32).v)},t}(Go);var Wr=[[0,{objectType:"Voxel",components:{spawnedByAny:{instancedMeshGraphics:{createInstanceIdPool:!1},voxelMeshInstancer:{}}}}],[1,{objectType:"Player",components:{spawnedByAny:{dynamicCollider:{collisionLayerMaskAtGroundLevel:31,hitboxSize:{sizeX:.6,sizeZ:.6}},speechBubble:{yOffset:2.4},playerProximityDetector:{maxDist:.45,maxLookAngle:-1}},spawnedByMe:{firstPersonController:{},objectSyncEmitter:{}},spawnedByOther:{modelGraphics:{path:"lowpolyghost/lowpolyghost.glb",localPosition:{x:0,y:1.22,z:0},scale:{x:.3,y:.3,z:.3}},objectSyncReceiver:{}}}}],[2,{objectType:"Canvas",components:{spawnedByAny:{instancedMeshGraphics:{createInstanceIdPool:!0},persistentObjectMeshInstancer:{},speechBubble:{yOffset:0},playerProximityDetector:{maxDist:3,maxLookAngle:.25*Math.PI}}}}]],Jr={},Yr={};Wr.forEach(function(e){Jr[e[0]]=e[1],Yr[e[1].objectType]=e[0]});const Hr=function(e){var t=Jr[e];if(null==t)throw new Error("getConfigByIndex :: Invalid object type index (objectTypeIndex = ".concat(e,")"));return t},Xr=function(e){var t=Yr[e];if(null==t)throw new Error("getIndexByType :: Invalid object type (objectType = ".concat(e,")"));return t};var Qr=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const Zr=function(e){function t(t){var n=e.call(this)||this;return n.n=t,n}return Qr(t,e),t.prototype.encode=function(e){(this.n<0||this.n>255)&&console.error("Number is out of its desired range (n = ".concat(this.n,")")),Math.floor(this.n)!=this.n&&console.error("Number is not an integer (n = ".concat(this.n,")"));var t=Math.min(255,Math.max(0,Math.floor(this.n)));e.view[e.byteIndex++]=t},t.decode=function(e){return new t(e.view[e.byteIndex++])},t}(Go);var Kr,$r=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const ea=function(e){function t(t){var n=e.call(this)||this;return n.map=t,n}return $r(t,e),t.prototype.encode=function(e){var t=Object.keys(this.map).map(Number);if(t.length>255)throw new Error("Too many keys in the EncodableMap :: ".concat(JSON.stringify(t)));new Zr(t.length).encode(e);for(var n=0,o=t;n<o.length;n++){var r=o[n];new Zr(r).encode(e),this.map[r].encode(e)}},t.decodeWithParams=function(e,n){return Kr=n,t.decode(e)},t.decode=function(e){for(var n=Zr.decode(e).n,o={},r=0;r<n;++r)o[Zr.decode(e).n]=Kr(e);return new t(o)},t}(Go);var ta=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const na=function(e){function t(t,n,o,r,a){void 0===a&&(a={});var c=e.call(this)||this;return c.sourceUserID=t,c.objectTypeIndex=n,c.objectId=o,c.transform=r,c.metadata=a,c}return ta(t,e),t.prototype.getMetadata=function(e){return null==this.metadata[e]?(console.error("Object metadata key '".concat(e,"' doesn't exist.")),""):this.metadata[e].str},t.prototype.hasMetadata=function(e){return null!=this.metadata[e]},t.prototype.setMetadata=function(e,t){this.metadata[e]=new zo(t)},t.prototype.deleteMetadata=function(e){null==this.metadata[e]?console.warn("Object metadata key '".concat(e,"' doesn't exist.")):delete this.metadata[e]},t.prototype.encode=function(e){new zo(this.sourceUserID).encode(e),new Zr(this.objectTypeIndex).encode(e),new zo(this.objectId).encode(e),this.transform.encode(e),new ea(this.metadata).encode(e)},t.decode=function(e){return new t(zo.decode(e).str,Zr.decode(e).n,zo.decode(e).str,nr.decode(e),ea.decodeWithParams(e,zo.decode).map)},t}(Go);var oa=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const ra=function(e){function t(t){var n=e.call(this)||this;return n.objectSpawnParams=t,n}return oa(t,e),t.prototype.encode=function(e){this.objectSpawnParams.encode(e)},t.decode=function(e){return new t(na.decode(e))},t}(Go);var aa,ca=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),ia=-1,sa=-1;const ua=function(e){function t(t,n,o,r){var a=e.call(this)||this;return a.quadsMem=t,a.gameObjectId="",a.row=n,a.col=o,a.collisionLayerMask=r,a}return ca(t,e),t.prototype.setGameObjectId=function(e){this.gameObjectId=e},t.prototype.encode=function(e){if(this.collisionLayerMask<0||this.collisionLayerMask>255)throw new Error("Voxel's collisionLayerMask is out of its range (value found = ".concat(this.collisionLayerMask,", range = [0:255])"));var t=this.quadsMem.quads,n=Rr(this.row,this.col);e.view[e.byteIndex++]=t[n+g-2],e.view[e.byteIndex++]=t[n+g-1],e.view[e.byteIndex++]=this.collisionLayerMask;for(var o=0;o<=7;){if(1<<o&this.collisionLayerMask)for(var r=Tr(this.row,this.col,o),a=r;a<r+6;++a)e.view[e.byteIndex++]=t[a];o++}},t.decodeWithParams=function(e,n,o,r){return aa=n,ia=o,sa=r,t.decode(e)},t.decode=function(e){var n=aa.quads,o=Rr(ia,sa);n[o+g-2]=e.view[e.byteIndex++],n[o+g-1]=e.view[e.byteIndex++];for(var r=e.view[e.byteIndex++],a=r;0!=a;)a>>=1;for(var c=0;c<=7;){var i=Tr(ia,sa,c);if(1<<c&r)for(var s=i;s<i+6;++s)n[s]=e.view[e.byteIndex++];else for(s=i;s<i+6;++s)n[s]=0;c++}return new t(aa,ia,sa,r)},t.prototype.toString=function(){for(var e=this.quadsMem.quads,t=["(".concat(this.row,",").concat(this.col,"):")],n=Rr(this.row,this.col),o=n;o<n+g;++o){var r=Dr(o),a=Mr(o),c=Er(o),i=e[o],s=127&i;128&i&&t.push("".concat(a).concat(r," at ").concat(c," (texture ").concat(s,")"))}return t.join("\n        ")},t}(Go),la=function(){this.quads=new Uint8Array(51200)};var fa=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),da=function(e){function t(t,n){var o=e.call(this)||this;return o.voxels=t,o.quadsMem=n,o}return fa(t,e),t.prototype.encode=function(e){new Zr(0).encode(e);for(var t=0,n=this.voxels;t<n.length;t++)n[t].encode(e)},t.decode=function(e){var n=Zr.decode(e).n;if(n<0){for(var o=ha[n](e),r=n;r<0;++r)o=ya[r](o);return o}var a=new Array(1024);a.length=0;for(var c=0,i=new la;c<1024;){var s=Math.floor(.03125*c),u=c%w;if(s<0||u<0||s>=32||u>=w)throw new Error("Decoded voxel coordinates are out of range (row = ".concat(s,", col = ").concat(u,")"));var l=ua.decodeWithParams(e,i,s,u);a[c++]=l}return new t(a,i)},t}(Go);const pa=da;var ha=[function(e){return new da([],new la)}],ya=[function(e){return new da([],new la)}],va=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const ma=function(e){function t(t,n,o,r,a,c,i){void 0===i&&(i={});var s=e.call(this)||this;return s.objectId=t,s.objectTypeIndex=n,s.direction=o,s.x=r,s.y=a,s.z=c,s.metadata=i,s}return va(t,e),t.prototype.encode=function(e){if(this.objectTypeIndex<0||this.objectTypeIndex>63)throw new Error("Object type index out of range (objectTypeIndex = ".concat(this.objectTypeIndex,")"));if(this.x<0||this.x>32)throw new Error("Object x out of range (x = ".concat(this.x,")"));if(this.z<0||this.z>32)throw new Error("Object z out of range (z = ".concat(this.z,")"));if(this.y<0||this.y>4)throw new Error("Object y out of range (y = ".concat(this.y,")"));e.view[e.byteIndex++]=this.objectTypeIndex<<2|("+z"==this.direction?0:"+x"==this.direction?1:"-z"==this.direction?2:3);var t=Math.floor(4*this.y),n=(12&t)>>2,o=3&t;e.view[e.byteIndex++]=Math.floor(2*this.x)<<2|n,e.view[e.byteIndex++]=Math.floor(2*this.z)<<2|o,new ea(this.metadata).encode(e)},t.decode=function(e){var n=e.view[e.byteIndex++],o=n>>2&63,r=3&n,a=r<=1?0==r?"+z":"+x":2==r?"-z":"-x",c=e.view[e.byteIndex++],i=.5*(c>>2&63),s=3&c,u=e.view[e.byteIndex++],l=.5*(u>>2&63),f=.25*(s<<2|3&u),d=ea.decodeWithParams(e,zo.decode).map;return new t("p".concat(i,"-").concat(f,"-").concat(l),o,a,i,f,l,d)},t}(Go);var ba=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const wa=function(e){function t(t){var n=e.call(this)||this;return n.n=t,n}return ba(t,e),t.prototype.encode=function(e){(this.n<0||this.n>65535)&&console.error("Number is out of its desired range (n = ".concat(this.n,")")),Math.floor(this.n)!=this.n&&console.error("Number is not an integer (n = ".concat(this.n,")"));var t=Math.min(65535,Math.max(0,Math.floor(this.n))),n=t>>8&255,o=255&t;e.view[e.byteIndex++]=n,e.view[e.byteIndex++]=o},t.decode=function(e){return new t(e.view[e.byteIndex++]<<8|e.view[e.byteIndex++])},t}(Go);var ga,xa=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Ia=0;const Oa=function(e){function t(t,n){var o=e.call(this)||this;return o.arr=t,o.lengthLimit=n,o}return xa(t,e),t.prototype.encode=function(e){this.arr.length>this.lengthLimit&&console.error("Encodable data array's length limit exceeded (length = ".concat(this.arr.length,", lengthLimit = ").concat(this.lengthLimit,")"));var t=Math.min(this.arr.length,this.lengthLimit);if(this.lengthLimit<=255)new Zr(t).encode(e);else{if(!(this.lengthLimit<=65535))throw new Error("Length limit of ".concat(this.lengthLimit," is not supported."));new wa(t).encode(e)}for(var n=0;n<t;++n)this.arr[n].encode(e)},t.decodeWithParams=function(e,n,o){return ga=n,Ia=o,t.decode(e)},t.decode=function(e){var n=0;if(Ia<256)n=Zr.decode(e).n;else{if(!(Ia<65536))throw new Error("Length limit of ".concat(Ia," is not supported."));n=wa.decode(e).n}for(var o=new Array(n),r=0;r<n;++r)o[r]=ga(e);return new t(o,Ia)},t}(Go);var ja=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Sa=function(e){function t(t){var n=e.call(this)||this;return n.persistentObjects=t,n}return ja(t,e),t.prototype.encode=function(e){new Zr(0).encode(e),new Oa(this.persistentObjects,65535).encode(e);for(var t=0,n=this.persistentObjects;t<n.length;t++)n[t].encode(e)},t.decode=function(e){var n=Zr.decode(e).n;if(n<0){for(var o=_a[n](e),r=n;r<0;++r)o=Ta[r](o);return o}return new t(Oa.decodeWithParams(e,ma.decode,65535).arr)},t}(Go);const ka=Sa;var _a=[function(e){return new Sa([])}],Ta=[function(e){return new Sa([])}],Ra={Hub:0,Regular:1},Pa=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),Da={};const Ma=function(e){function t(t,n){var o=e.call(this)||this;return o.enumValue=t,o.enumMap=n,o}return Pa(t,e),t.prototype.encode=function(e){e.view[e.byteIndex++]=this.enumMap[this.enumValue]},t.decodeWithParams=function(e,n){return Da=n,t.decode(e)},t.decode=function(e){return new t(Da[e.view[e.byteIndex++]],Da)},t}(Go);var Ea=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const Ua=function(e){function t(t,n,o,r,a,c,i){var s=e.call(this)||this;return s.id=null!=t?t:"",s.roomName=n,s.roomType=o,s.ownerUserID=r,s.texturePackPath=a,s.voxelGrid=c,s.persistentObjectGroup=i,s.dirty=!1,s}return Ea(t,e),Object.defineProperty(t.prototype,"voxelQuads",{get:function(){return this.voxelGrid.quadsMem.quads},enumerable:!1,configurable:!0}),t.prototype.encode=function(e){new zo(this.id.length>0?this.id:"?").encode(e),new zo(this.roomName).encode(e),new Ma(this.roomType,Ra).encode(e),new zo(this.ownerUserID).encode(e),new zo(this.texturePackPath).encode(e),this.voxelGrid.encode(e),this.persistentObjectGroup.encode(e)},t.decode=function(e){var n=zo.decode(e).str;return"?"==n&&(n=void 0),new t(n,zo.decode(e).str,Ma.decodeWithParams(e,Ra).enumValue,zo.decode(e).str,zo.decode(e).str,pa.decode(e),ka.decode(e))},t}(Go);var La=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const Ba=function(e){function t(t,n,o){var r=e.call(this)||this;return r.room=t,r.participantUserIDs=n,r.objectRuntimeMemories=o,r.lastSavedTimeInMillis=Date.now(),r}return La(t,e),t.prototype.encode=function(e){this.room.encode(e),new Oa(Object.keys(this.participantUserIDs).map(function(e){return new zo(e)}),65535).encode(e),new Oa(Object.values(this.objectRuntimeMemories),65535).encode(e)},t.decode=function(e){for(var n=Ua.decode(e),o={},r=0,a=Oa.decodeWithParams(e,zo.decode,65535).arr;r<a.length;r++)o[a[r].str]=!0;for(var c={},i=0,s=Oa.decodeWithParams(e,ra.decode,65535).arr;i<s.length;i++){var u=s[i];c[u.objectSpawnParams.objectId]=u}return new t(n,o,c)},t}(Go);const Ca=function(){function e(e,t){this.quadIndex=e,this.newQuad=t}return e.prototype.toString=function(){var e=Ur(this.quadIndex),t=Lr(this.quadIndex),n=Dr(this.quadIndex),o=Mr(this.quadIndex),r=Er(this.quadIndex),a=!!(128&this.newQuad),c=127&this.newQuad;return"(".concat(e,",").concat(t,") ").concat(o).concat(n," at ").concat(r," ---\x3e ").concat(a?"show":"hide"," texture ").concat(c,"\n    Result: ").concat(this.voxelQuadsResultSnapshot||"(?)")},e}();function Aa(e,t,n,o,r,a){void 0===a&&(a=-1);var c=_r(t.row,t.col,n,o,r),i=t.quadsMem.quads[c],s=127&(a>=0?a:127&i)|(e?128:0);if(s==i)return!1;t.quadsMem.quads[c]=s;var u=new Ca(c,s);return E.set(u),!0}function Na(e,t,n,o,r){var a=Rr(t,n);Fa(e,a),e[a+g-2]=128|r,e[a+g-1]=128|o}function Ga(e,t,n,o,r,a){Fa(e,Rr(t,n));for(var c=0;c<=7;++c)e[Tr(t,n,c)+Pr(o,r)]=128|a}function Fa(e,t){for(var n=t;n<t+g;++n)e[n]=0}const qa={generateEmptyRoom:function(e,t,n){var o=new Array(1024),r=new la;Fa(r.quads,Rr(0,0)),Fa(r.quads,Rr(0,31)),Fa(r.quads,Rr(31,0)),Fa(r.quads,Rr(31,31)),o[0]=new ua(r,0,0,0),o[31]=new ua(r,0,31,0),o[992]=new ua(r,31,0,0),o[1023]=new ua(r,31,31,0);for(var a=1;a<31;++a)for(var c=1;c<31;++c)Na(r.quads,a,c,e,n),o[a*w+c]=new ua(r,a,c,0);for(c=1;c<31;++c){Ga(r.quads,0,c,"z","+",t),Ga(r.quads,31,c,"z","-",t);var i=new ua(r,0,c,255);o[c]=i;var s=new ua(r,31,c,255);o[992+c]=s;for(var u=0;u<=7;++u)Aa(!0,i,"z","+",u,t),Aa(!0,s,"z","-",u,t)}for(a=1;a<31;++a)for(Ga(r.quads,a,0,"x","+",t),Ga(r.quads,a,31,"x","-",t),i=new ua(r,a,0,255),o[a*w]=i,s=new ua(r,a,31,255),o[a*w+w-1]=s,u=0;u<=7;++u)Aa(!0,i,"x","+",u,t),Aa(!0,s,"x","-",u,t);return{voxelGrid:new pa(o,r),persistentObjectGroup:new ka([])}}},za=function(e,t){void 0===t&&(t=0),this.view=e,this.byteIndex=t};var Va=new ArrayBuffer(65536),Wa=!1,Ja=0;const Ya=function(e){if(void 0===e&&(e=0),Wa)throw new Error("WriteBuffer is already reserved.");return Wa=!0,Ja=e,new za(new Uint8Array(Va,e))},Ha=function(e){Wa||console.error("WriteBuffer is already free."),Wa=!1;var t=e.view.buffer.slice(Ja,e.byteIndex);return Ja=0,t};var Xa=function(e,t,n,o){return new(n||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())})},Qa=function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}};const Za=function(e,t){return Xa(void 0,void 0,void 0,function(){var n;return Qa(this,function(o){switch(o.label){case 0:L.log("DBFileStorageUtil.saveBinaryFile",{filePath:e,bufferLength:t.length},"low","info"),o.label=1;case 1:return o.trys.push([1,4,,5]),[4,un()];case 2:return[4,o.sent().bucket().file(e).save(t,{metadata:{contentType:"application/octet-stream"},resumable:!1})];case 3:return o.sent(),[2,!0];case 4:return n=o.sent(),L.log("DBFileStorageUtil.saveBinaryFile failed",{errorMessage:en(n)},"high","error"),[2,!1];case 5:return[2]}})})},Ka=function(e){return Xa(void 0,void 0,void 0,function(){var t,n,o;return Qa(this,function(r){switch(r.label){case 0:L.log("DBFileStorageUtil.loadBinaryFile",{filePath:e},"low","info"),r.label=1;case 1:return r.trys.push([1,4,,5]),[4,un()];case 2:return[4,r.sent().bucket().file(e).download()];case 3:return t=r.sent(),(n=Buffer.concat(t)).length>0?[2,n]:[2,null];case 4:return o=r.sent(),L.log("DBFileStorageUtil.loadBinaryFile failed",{errorMessage:en(o)},"high","error"),[2,null];case 5:return[2]}})})},$a=function(e){return Xa(void 0,void 0,void 0,function(){var t,n,o,r,a,c;return Qa(this,function(i){switch(i.label){case 0:L.log("DBFileStorageUtil.deleteFile",{filePath:e},"low","info"),i.label=1;case 1:return i.trys.push([1,4,,5]),[4,un()];case 2:return[4,i.sent().bucket().file(e).delete()];case 3:for(t=i.sent(),n=0,o=t;n<o.length;n++)if(r=o[n],(a=r.statusCode)<200||a>=300)return L.log("DBFileStorageUtil.deleteFile :: failure found in response",{response:JSON.stringify(r)},"high","error"),[2,!1];return[2,!0];case 4:return c=i.sent(),L.log("DBFileStorageUtil.deleteFile :: failed",{errorMessage:en(c)},"high","error"),[2,!1];case 5:return[2]}})})};var ec=function(e,t,n,o){return new(n||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())})},tc=function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},nc={getRoomContent:function(e){return ec(void 0,void 0,void 0,function(){var t;return tc(this,function(n){switch(n.label){case 0:return L.log("DBRoomUtil.getRoomContent",{roomID:e},"low","info"),[4,(new Mn).select().from(I).where("id","==",e).run()];case 1:return(t=n.sent()).success&&0!=t.data.length?[4,oc(t.data[0])]:[2,null];case 2:return[2,n.sent()]}})})},saveRoomContent:function(e){return ec(void 0,void 0,void 0,function(){var t,n;return tc(this,function(o){switch(o.label){case 0:return L.log("DBRoomUtil.saveRoomContent",{roomID:e.id},"low","info"),t=Ya(),e.voxelGrid.encode(t),e.persistentObjectGroup.encode(t),n=Buffer.from(Ha(t)),[4,Za(rc(e.id),n)];case 1:return[2,o.sent()]}})})},deleteRoomContent:function(e){return ec(void 0,void 0,void 0,function(){return tc(this,function(t){switch(t.label){case 0:return L.log("DBRoomUtil.deleteRoomContent",{roomID:e.id},"low","info"),[4,$a(rc(e.id))];case 1:return[2,t.sent()]}})})},createRoom:function(e,t,n,o,r,a,c){return ec(void 0,void 0,void 0,function(){var i,s,u,l,f,d;return tc(this,function(p){switch(p.label){case 0:return L.log("DBRoomUtil.createRoom",{roomName:e,roomType:t,ownerUserID:n,floorTextureIndex:o,wallTextureIndex:r,ceilingTextureIndex:a,texturePackPath:c},"low","info"),i=qa.generateEmptyRoom(o,r,a),s=i.voxelGrid,u=i.persistentObjectGroup,l=new Ua(void 0,e,t,n,c,s,u),f=function(e){return{id:e.id,version:fn.length,roomName:e.roomName,roomType:e.roomType,ownerUserID:e.ownerUserID,texturePackPath:e.texturePackPath}}(l),[4,(new Mn).insertInto(I).values(f).run()];case 1:return(d=p.sent()).success?[3,3]:[4,nc.deleteRoomContent(l)];case 2:return p.sent(),[2,{success:!1,data:[]}];case 3:return l.id=d.data[0].id,[4,nc.saveRoomContent(l)];case 4:return p.sent()?[2,d]:[2,{success:!1,data:[]}]}})})},deleteRoom:function(e){return ec(void 0,void 0,void 0,function(){return tc(this,function(t){switch(t.label){case 0:return L.log("DBRoomUtil.deleteRoom",{roomID:e},"low","info"),[4,(new Mn).delete().from(I).where("id","==",e).run()];case 1:return[2,t.sent().success]}})})},changeRoomName:function(e,t){return ec(void 0,void 0,void 0,function(){return tc(this,function(n){switch(n.label){case 0:return L.log("DBRoomUtil.changeRoomName",{roomID:e.id,newRoomName:t},"low","info"),[4,(new Mn).update(I).set({roomName:t}).where("id","==",e.id).run()];case 1:return[2,n.sent().success]}})})}};function oc(e){return ec(this,void 0,void 0,function(){var t,n,o,r;return tc(this,function(a){switch(a.label){case 0:return[4,Ka(rc(e.id))];case 1:return(t=a.sent())?(n=new za(new Uint8Array(t)),o=pa.decode(n),r=ka.decode(n),[2,new Ua(e.id,e.roomName,e.roomType,e.ownerUserID,e.texturePackPath,o,r)]):[2,null]}})})}function rc(e){if(!e)throw new Error("getRoomContentFilePath :: roomID not found.");return"".concat(I,"/").concat(e,"/content.bin")}const ac=nc,cc=function(){function e(){this.socketUserContexts={}}return e.prototype.getUserContexts=function(){return this.socketUserContexts},e.prototype.multicastSignal=function(e,t,n){void 0===n&&(n=void 0);for(var o=0,r=Object.entries(this.socketUserContexts);o<r.length;o++){var a=r[o],c=a[0],i=a[1];c!=n&&i.addPendingSignalToUser(e,t)}},e.prototype.unicastSignal=function(e,t,n){var o=this.socketUserContexts[n];null!=o?o.addPendingSignalToUser(e,t):console.error("SocketUserContext not found (targetUserID = ".concat(n,")"))},e.prototype.addSocketUserContext=function(e,t){null==this.socketUserContexts[e]?this.socketUserContexts[e]=t:console.error("SocketUserContext already exists (userID = ".concat(e,")"))},e.prototype.removeSocketUserContext=function(e){null!=this.socketUserContexts[e]?delete this.socketUserContexts[e]:console.error("SocketUserContext doesn't exist (userID = ".concat(e,")"))},e}();function ic(e){return t=this,n=void 0,r=function(){var t,n;return function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,function(o){switch(o.label){case 0:if(console.log("RoomManager.loadRoom :: roomID = ".concat(e)),null!=Wc.roomRuntimeMemories[e])throw new Error("RoomManager.loadRoom :: RoomRuntimeMemory already exists (roomID = ".concat(e,")"));return[4,ac.getRoomContent(e)];case 1:return(t=o.sent())?(n=new Ba(t,{},{}),Wc.roomRuntimeMemories[e]=n,Wc.socketRoomContexts[e]=new cc,Ar.load(n),[2,n]):[2,null]}})},new((o=void 0)||(o=Promise))(function(e,a){function c(e){try{s(r.next(e))}catch(e){a(e)}}function i(e){try{s(r.throw(e))}catch(e){a(e)}}function s(t){var n;t.done?e(t.value):(n=t.value,n instanceof o?n:new o(function(e){e(n)})).then(c,i)}s((r=r.apply(t,n||[])).next())});var t,n,o,r}var sc=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const uc=function(e){function t(t){var n=e.call(this)||this;return n.objectId=t,n}return sc(t,e),t.prototype.encode=function(e){new zo(this.objectId).encode(e)},t.decode=function(e){return new t(zo.decode(e).str)},t}(Go);function lc(e,t){var n,o,r,a=e.socket.handshake.auth,c=Wc.currentRoomIDByUserID[a.id];if(console.log("RoomManager.removeObject :: roomID = ".concat(c,", userID = ").concat(a.id,", objectId = ").concat(t)),null!=c){var i=Wc.roomRuntimeMemories[c];if(null!=i){var s=i.objectRuntimeMemories[t];if(null!=s){delete i.objectRuntimeMemories[t];var u=Hr(s.objectSpawnParams.objectTypeIndex);(null!==(o=null===(n=u.components.spawnedByAny)||void 0===n?void 0:n.dynamicCollider)&&void 0!==o?o:null===(r=u.components.spawnedByAny)||void 0===r?void 0:r.staticCollider)&&Ar.removeObject(c,t);var l=new uc(t),f=Wc.socketRoomContexts[c];f?f.multicastSignal("objectDespawnParams",l,a.id):console.error("RoomManager.removeObject :: SocketRoomContext not found (roomID = ".concat(c,")"))}else console.error("RoomManager.removeObject :: ObjectRuntimeMemory doesn't exist (roomID = ".concat(c,", objectId = ").concat(t,")"))}else console.error("RoomManager.removeObject :: RoomRuntimeMemory doesn't exist (roomID = ".concat(c,", objectId = ").concat(t,")"))}else console.error("RoomManager.removeObject :: RoomID not found (userID = ".concat(a.id,", objectId = ").concat(t,")"))}function fc(e,t){return n=this,o=arguments,a=function(e,t,n){var o,r,a,c,i,s,u,l,f;return void 0===n&&(n=!0),function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,function(d){switch(d.label){case 0:return o=e.socket.handshake.auth,r=Wc.currentRoomIDByUserID[o.id],console.log("RoomManager.removeUserFromRoom :: roomID = ".concat(r,", userID = ").concat(o.id)),null==r?(t&&console.warn("RoomManager.removeUserFromRoom :: Previous room not found :: userID = ".concat(o.id)),[2]):null==(a=Wc.roomRuntimeMemories[r])?(console.error("RoomManager.removeUserFromRoom :: RoomRuntimeMemory doesn't exist (roomID = ".concat(r,")")),[2]):n&&(c=dc(e,a))?[4,Cn.saveUserGameplayState(c)]:[3,2];case 1:d.sent(),d.label=2;case 2:for(i=function(e,t){var n=Wc.roomRuntimeMemories[e];if(null==n)return console.error("RoomManager.getIdsOfObjectsSpawnedByUser :: RoomRuntimeMemory doesn't exist (roomID = ".concat(e,")")),[];for(var o=[],r=0,a=Object.entries(n.objectRuntimeMemories);r<a.length;r++){var c=a[r],i=c[0];c[1].objectSpawnParams.sourceUserID==t&&o.push(i)}return o}(r,o.id),s=0,u=i;s<u.length;s++)l=u[s],lc(e,l);return null==a.participantUserIDs[o.id]?(console.error("RoomManager.removeUserFromRoom :: User is not registered as the room's participant (userID = ".concat(o.id,", roomID = ").concat(r,")")),[2]):(delete Wc.currentRoomIDByUserID[o.id],delete a.participantUserIDs[o.id],(f=Wc.socketRoomContexts[r])?f.removeSocketUserContext(o.id):console.error("RoomManager.removeUserFromRoom :: SocketRoomContext not found (roomID = ".concat(r,")")),0!=Object.keys(a.participantUserIDs).length?[3,4]:[4,ac.saveRoomContent(a.room)]);case 3:d.sent()&&function(e){console.log("RoomManager.unloadRoom :: roomID = ".concat(e));var t=Wc.roomRuntimeMemories[e];if(null==Wc.roomRuntimeMemories[e])throw new Error("RoomManager.unloadRoom :: RoomRuntimeMemory doesn't exist (roomID = ".concat(e,")"));if(Object.keys(t.participantUserIDs).length>0)throw new Error("RoomManager.unloadRoom :: There are still participants in the room (participants = [".concat(JSON.stringify(t.participantUserIDs),"])"));delete Wc.roomRuntimeMemories[e],delete Wc.socketRoomContexts[e],Ar.unload(e)}(r),d.label=4;case 4:return[2]}})},new((r=void 0)||(r=Promise))(function(e,t){function c(e){try{s(a.next(e))}catch(e){t(e)}}function i(e){try{s(a.throw(e))}catch(e){t(e)}}function s(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r(function(e){e(n)})).then(c,i)}s((a=a.apply(n,o||[])).next())});var n,o,r,a}function dc(e,t){var n=e.socket.handshake.auth,o=t.objectRuntimeMemories[n.id];if(o){for(var r=o.objectSpawnParams.transform,a=o.objectSpawnParams.metadata,c={},i=0,s=Object.keys(a);i<s.length;i++){var u=s[i];c[u]=a[u].str}return{userID:n.id,lastRoomID:t.room.id,lastX:r.x,lastY:r.y,lastZ:r.z,lastDirX:r.dirX,lastDirY:r.dirY,lastDirZ:r.dirZ,playerMetadata:c,sessionDurationMs:Date.now()-e.connectTime}}console.error("getUserGameplayState :: Player's ObjectRuntimeMemory not found (userID = ".concat(n.id,")"))}var pc=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const hc=function(e){function t(t){var n=e.call(this)||this;return n.type=t,n}return pc(t,e),t.prototype.encode=function(e){throw new Error("Thie 'encode' method in UpdateVoxelGridTaskParams must be overriden by a child class.")},t.decode=function(e){throw new Error("Thie 'decode' method in UpdateVoxelGridTaskParams must be overriden by a child class.")},t}(Go);var yc=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const vc=function(e){function t(t,n){var o=e.call(this,1)||this;return o.quadIndex=t,o.quadTextureIndicesWithinLayer=n,o}return yc(t,e),t.prototype.encode=function(e){new wa(this.quadIndex).encode(e);for(var t=0;t<6;++t)new Zr(this.quadTextureIndicesWithinLayer[t]).encode(e)},t.decode=function(e){for(var n=wa.decode(e).n,o=new Array(6),r=0;r<6;++r)o[r]=Zr.decode(e).n;return new t(n,o)},t}(hc);var mc=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const bc=function(e){function t(t){var n=e.call(this)||this;return n.n=t,n}return mc(t,e),t.prototype.encode=function(e){(this.n<-128||this.n>127)&&console.error("Number is out of its desired range (n = ".concat(this.n,")")),Math.floor(this.n)!=this.n&&console.error("Number is not an integer (n = ".concat(this.n,")"));var t=Math.min(127,Math.max(-128,Math.floor(this.n)))+128;e.view[e.byteIndex++]=t},t.decode=function(e){return new t(e.view[e.byteIndex++]-128)},t}(Go);var wc=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const gc=function(e){function t(t,n,o,r){var a=e.call(this,0)||this;return a.quadIndex=t,a.rowOffset=n,a.colOffset=o,a.collisionLayerOffset=r,a}return wc(t,e),t.prototype.encode=function(e){new wa(this.quadIndex).encode(e),new bc(this.rowOffset).encode(e),new bc(this.colOffset).encode(e),new bc(this.collisionLayerOffset).encode(e)},t.decode=function(e){return new t(wa.decode(e).n,bc.decode(e).n,bc.decode(e).n,bc.decode(e).n)},t}(hc);var xc=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const Ic=function(e){function t(t){var n=e.call(this,2)||this;return n.quadIndex=t,n}return xc(t,e),t.prototype.encode=function(e){new wa(this.quadIndex).encode(e)},t.decode=function(e){return new t(wa.decode(e).n)},t}(hc);var Oc=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const jc=function(e){function t(t,n){var o=e.call(this,3)||this;return o.quadIndex=t,o.textureIndex=n,o}return Oc(t,e),t.prototype.encode=function(e){new wa(this.quadIndex).encode(e),new Zr(this.textureIndex).encode(e)},t.decode=function(e){return new t(wa.decode(e).n,Zr.decode(e).n)},t}(hc);var Sc=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const kc=function(e){function t(t){var n=e.call(this)||this;return n.tasks=t,n}return Sc(t,e),t.prototype.encode=function(e){for(var t=0,n=this.tasks;t<n.length;t++){var o=n[t];new Zr(o.type).encode(e),o.encode(e)}},t.decode=function(e){for(var n=[];e.byteIndex<e.view.byteLength;){var o=Zr.decode(e).n;switch(o){case 0:n.push(gc.decode(e));break;case 1:n.push(vc.decode(e));break;case 2:n.push(Ic.decode(e));break;case 3:n.push(jc.decode(e));break;default:console.error("Unknown task type :: ".concat(o))}}return new t(n)},t}(Go);function _c(e,t,n){var o=Ur(t),r=Lr(t),a=Er(t);if(a<0||a>7)return console.warn("collisionLayer is out of range (row: ".concat(o,", col: ").concat(r,", collisionLayer = ").concat(a,")")),!1;if(o<=0||r<=0||o>=31||r>=31)return console.warn("Cannot change a boundary voxel. (row: ".concat(o,", col: ").concat(r,", collisionLayer = ").concat(a,")")),!1;var c=jr(e,o,r);return c?Sr(c,a)?(console.error("Voxel block already exists (row: ".concat(o,", col: ").concat(r,", collisionLayer: ").concat(a,")")),!1):(c.collisionLayerMask^=1<<a,Rc(e,c,a,n),!0):(console.error("No voxel found in (row: ".concat(o,", col: ").concat(r,")")),!1)}function Tc(e,t){var n=Ur(t),o=Lr(t),r=Er(t);if(r<0||r>7)return console.warn("collisionLayer is out of range (row: ".concat(n,", col: ").concat(o,", collisionLayer = ").concat(r,")")),!1;if(n<=0||o<=0||n>=31||o>=31)return console.warn("Cannot change a boundary voxel. (row: ".concat(n,", col: ").concat(o,", collisionLayer = ").concat(r,")")),!1;var a=jr(e,n,o);return a?Sr(a,r)?(a.collisionLayerMask^=1<<r,Rc(e,a,r),!0):(console.error("No voxel block to remove (row: ".concat(n,", col: ").concat(o,", collisionLayer: ").concat(r,")")),!1):(console.error("No voxel found in (row: ".concat(n,", col: ").concat(o,")")),!1)}function Rc(e,t,n,o){var r=n-1;r<0&&(r=8);var a=n+1;a>7&&(a=8),Pc(e,t,n,r,a,"y","-",null!=o?o[Pr("y","-")]:void 0),Pc(e,t,n,r,a,"y","+",null!=o?o[Pr("y","+")]:void 0),Pc(e,t,n,r,a,"x","-",null!=o?o[Pr("x","-")]:void 0),Pc(e,t,n,r,a,"x","+",null!=o?o[Pr("x","+")]:void 0),Pc(e,t,n,r,a,"z","-",null!=o?o[Pr("z","-")]:void 0),Pc(e,t,n,r,a,"z","+",null!=o?o[Pr("z","+")]:void 0)}function Pc(e,t,n,o,r,a,c,i){void 0===i&&(i=-1);var s=t,u=n;switch(a){case"y":u="-"==c?o:r;break;case"x":s=jr(e,t.row,t.col+("-"==c?-1:1));break;case"z":s=jr(e,t.row+("-"==c?-1:1),t.col)}var l=Sr(t,n),f=Sr(s,u),d=f&&!l;Aa(l&&!f,t,a,c,n,i),Aa(d,s,a,"-"==c?"+":"-",u)}function Dc(e,t){var n=Bc(e);n&&function(e,t,n,o,r){var a=Ur(t),c=Lr(t),i=Er(t);if(!jr(e,a,c))return console.error("No voxel found in (row: ".concat(a,", col: ").concat(c,")")),!1;for(var s=[],u=Tr(a,c,i),l=u;l<u+6;++l)s.push(127&e.voxelGrid.quadsMem.quads[l]);var f=i+r;return(f<0||f>7)&&(f=8),_c(e,_r(a+n,c+o,"y","-",f),s)&&Tc(e,t)}(n,t.quadIndex,t.rowOffset,t.colOffset,t.collisionLayerOffset)?Lc(e,n,t):console.error("Voxel update failed (moveVoxelBlockTask) - params: ".concat(JSON.stringify(t)))}function Mc(e,t){var n=Bc(e);n&&_c(n,t.quadIndex,t.quadTextureIndicesWithinLayer)?Lc(e,n,t):console.error("Voxel update failed (addVoxelBlockTask) - params: ".concat(JSON.stringify(t)))}function Ec(e,t){var n=Bc(e);n&&Tc(n,t.quadIndex)?Lc(e,n,t):console.error("Voxel update failed (removeVoxelBlockTask) - params: ".concat(JSON.stringify(t)))}function Uc(e,t){var n=Bc(e);if(n){var o=t.quadIndex,r=jr(n,Ur(o),Lr(o));r?Aa(!0,r,Dr(o),Mr(o),Er(o),t.textureIndex)?Lc(e,n,t):console.error("Voxel update failed (setVoxelQuadTextureTask) - params: ".concat(JSON.stringify(t))):console.error("Voxel update failed (setVoxelQuadTextureTask) - voxel not found - params: ".concat(JSON.stringify(t)))}else console.error("Voxel update failed (setVoxelQuadTextureTask) - room not found - params: ".concat(JSON.stringify(t)))}function Lc(e,t,n,o){t.dirty=!0;var r=e.socket.handshake.auth,a=Wc.socketRoomContexts[t.id];a?Object.entries(a.getUserContexts()).forEach(function(e){if(r.id!=e[0]){var t=e[1];t.tryUpdateLatestPendingSignalToUser("updateVoxelGridParams",function(e){e.tasks.push(n)})||t.addPendingSignalToUser("updateVoxelGridParams",new kc([n]))}}):console.error("SocketRoomContext not found (roomID = ".concat(t.id,")"))}function Bc(e){var t=e.socket.handshake.auth,n=Wc.currentRoomIDByUserID[t.id];if(null!=n){var o=Wc.roomRuntimeMemories[n];if(null!=o)return o.room;console.error("getRoom :: RoomRuntimeMemory doesn't exist (roomID = ".concat(n,")"))}else console.error("getRoom :: RoomID not found (userID = ".concat(t.id,")"))}var Cc=function(e,t,n,o){return new(n||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())})},Ac=function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},Nc=function(e,t,n){if(n||2===arguments.length)for(var o,r=0,a=t.length;r<a;r++)!o&&r in t||(o||(o=Array.prototype.slice.call(t,0,r)),o[r]=t[r]);return e.concat(o||Array.prototype.slice.call(t))},Gc={},Fc={},qc={},zc={roomRuntimeMemories:Gc,socketRoomContexts:Fc,currentRoomIDByUserID:qc,saveRooms:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return Cc(void 0,Nc([],e,!0),void 0,function(e){var t,n,o,r,a,c,i;return void 0===e&&(e=!1),Ac(this,function(s){switch(s.label){case 0:for(t=Date.now(),n=[],o=0,r=Object.values(Gc);o<r.length;o++)(a=r[o]).room.dirty&&(e||t>=a.lastSavedTimeInMillis+6e5)&&n.push(a);c=5,i=0,s.label=1;case 1:return i<n.length?[4,Promise.all(n.slice(i,i+c).map(function(e){return Cc(void 0,void 0,void 0,function(){return Ac(this,function(t){switch(t.label){case 0:return[4,ac.saveRoomContent(e.room)];case 1:return t.sent()?(e.lastSavedTimeInMillis=Date.now(),e.room.dirty=!1,console.log("RoomManager.saveRooms :: Saved room (roomID = ".concat(e.room.id,")"))):console.error("RoomManager.saveRooms :: Failed to save room (roomID = ".concat(e.room.id,")")),[2]}})})}))]:[3,4];case 2:s.sent(),s.label=3;case 3:return i+=c,[3,1];case 4:return[2]}})})},saveAllUserGameplayStates:function(e){return Cc(void 0,void 0,void 0,function(){var t,n,o,r,a,c,i,s,u;return Ac(this,function(l){switch(l.label){case 0:for(t=[],n=0,o=Object.entries(qc);n<o.length;n++)r=o[n],a=r[0],c=r[1],(i=Gc[c])?(s=e[a])?(u=dc(s,i))&&t.push(u):console.error("RoomManager.saveAllUserGameplayStates :: SocketUserContext not found (userID = ".concat(a,")")):console.error("RoomManager.saveAllUserGameplayStates :: RoomRuntimeMemory not found (roomID = ".concat(c,")"));return[4,Cn.saveMultipleUsersGameplayState(t)];case 1:return l.sent(),[2]}})})},changeUserRoom:function(e,t,n){for(var o=[],r=3;r<arguments.length;r++)o[r-3]=arguments[r];return Cc(void 0,Nc([e,t,n],o,!0),void 0,function(e,t,n,o){var r,a,c,i;return void 0===o&&(o=!0),Ac(this,function(s){switch(s.label){case 0:return r=e.socket.handshake.auth,console.log("RoomManager.changeUserRoom :: roomID = ".concat(t,", userID = ").concat(r.id)),[4,fc(e,n,o)];case 1:return s.sent(),t?(a=Gc[t])?[3,3]:[4,ic(t)]:[2,!1];case 2:(c=s.sent())&&(a=c),s.label=3;case 3:return a?(function(e,t,n,o){var r=e.socket.handshake.auth;if(console.log("RoomManager.addUserToRoom :: roomID = ".concat(t.room.id,", userID = ").concat(n)),null==t.participantUserIDs[n]){Wc.currentRoomIDByUserID[n]=t.room.id,t.participantUserIDs[n]=!0;var a=Wc.socketRoomContexts[t.room.id];a?a.addSocketUserContext(n,e):console.error("RoomManager.addUserToRoom :: SocketRoomContext not found (roomID = ".concat(t.room.id,")"));for(var c={},i=0,s=Object.keys(r.playerMetadata);i<s.length;i++){var u=s[i];c[parseInt(u)]=new zo(r.playerMetadata[u])}!function(e,t){var n,o,r,a=e.socket.handshake.auth,c=Wc.currentRoomIDByUserID[a.id],i=t.objectSpawnParams.objectId;if(console.log("RoomManager.addObject :: roomID = ".concat(c,", userID = ").concat(a.id,", objectId = ").concat(i)),null!=c){var s=Wc.roomRuntimeMemories[c];if(null!=s)if(null==s.objectRuntimeMemories[i]){s.objectRuntimeMemories[i]=t;var u=Hr(t.objectSpawnParams.objectTypeIndex),l=null!==(o=null===(n=u.components.spawnedByAny)||void 0===n?void 0:n.dynamicCollider)&&void 0!==o?o:null===(r=u.components.spawnedByAny)||void 0===r?void 0:r.staticCollider;if(l){var f=.5*l.hitboxSize.sizeX,d=.5*l.hitboxSize.sizeZ,p={x:t.objectSpawnParams.transform.x,y:t.objectSpawnParams.transform.z,halfSizeX:f,halfSizeY:d};Ar.addObject(c,i,t.objectSpawnParams.transform.y,p,l.collisionLayerMaskAtGroundLevel)}var h=Wc.socketRoomContexts[c];h?h.multicastSignal("objectSpawnParams",t.objectSpawnParams,a.id):console.error("RoomManager.addObject :: SocketRoomContext not found (roomID = ".concat(c,")"))}else console.error("RoomManager.addObject :: ObjectRuntimeMemory already exists (roomID = ".concat(c,", objectId = ").concat(i,")"));else console.error("RoomManager.addObject :: RoomRuntimeMemory doesn't exist (roomID = ".concat(c,", objectId = ").concat(i,")"))}else console.error("RoomManager.addObject :: RoomID not found (userID = ".concat(a.id,", objectId = ").concat(i,")"))}(e,new ra(new na(r.id,Xr("Player"),r.id,o,c)))}else console.error("RoomManager.addUserToRoom :: User is already registered (roomID = ".concat(t.room.id,", userID = ").concat(n,")"))}(e,a,r.id,new nr(r.lastX,r.lastY,r.lastZ,r.lastDirX,r.lastDirY,r.lastDirZ)),(i=Fc[t])?i.unicastSignal("roomRuntimeMemory",a,r.id):console.error("RoomManager.changeUserRoom :: SocketRoomContext not found (roomID = ".concat(t,")")),[2,!0]):(console.error("Failed to load room (ID = ".concat(t,")")),[2,!1])}})})},updateVoxelGrid:function(e,t){!function(e,t){for(var n=0,o=t.tasks;n<o.length;n++){var r=o[n];switch(r.type){case 0:Dc(e,r);break;case 1:Mc(e,r);break;case 2:Ec(e,r);break;case 3:Uc(e,r);break;default:console.error("Unknown task type :: ".concat(r.type))}}}(e,t)},sendObjectMessage:function(e,t){var n=e.socket.handshake.auth,o=qc[n.id];if(null!=o){var r=Gc[o];if(null!=r){var a=r.objectRuntimeMemories[t.senderObjectId];if(null!=a)if(a.objectSpawnParams.sourceUserID==n.id){t.message=t.message.trim().substring(0,32),a.objectSpawnParams.setMetadata(0,t.message);var c=Fc[o];c?c.multicastSignal("objectMessageParams",t,n.id):console.error("RoomManager.sendObjectMessage :: SocketRoomContext not found (roomID = ".concat(o,")"))}else console.error("RoomManager.sendObjectMessage :: User has no authority to control this object (roomID = ".concat(o,", objectId = ").concat(t.senderObjectId,")"));else console.error("RoomManager.sendObjectMessage :: ObjectRuntimeMemory doesn't exist (roomID = ".concat(o,", objectId = ").concat(t.senderObjectId,")"))}else console.error("RoomManager.sendObjectMessage :: RoomRuntimeMemory doesn't exist (roomID = ".concat(o,")"))}else console.error("RoomManager.sendObjectMessage :: RoomID not found (userID = ".concat(n.id,")"))},updateObjectTransform:function(e,t,n){var o=e.socket.handshake.auth,r=qc[o.id];if(null!=r){var a=Gc[r];if(null!=a){var c=a.objectRuntimeMemories[t];if(null!=c)if(c.objectSpawnParams.sourceUserID==o.id){var i={x:n.x,y:n.z},s=Ar.tryMoveObject(r,t,i);if(n.x=s.resolvedPos.x,n.z=s.resolvedPos.y,Object.assign(c.objectSpawnParams.transform,n),s.desyncDetected){var u=new Vr(t,s.resolvedPos);(l=Fc[r])?l.multicastSignal("objectDesyncResolveParams",u):console.error("RoomManager.updateObjectTransform :: SocketRoomContext not found (roomID = ".concat(r,")"))}else{var l;u=new rr(t,n),(l=Fc[r])?l.multicastSignal("objectSyncParams",u,o.id):console.error("RoomManager.updateObjectTransform :: SocketRoomContext not found (roomID = ".concat(r,")"))}}else console.error("RoomManager.updateObjectTransform :: User has no authority to control this object (roomID = ".concat(r,", objectId = ").concat(t,")"));else console.error("RoomManager.updateObjectTransform :: ObjectRuntimeMemory doesn't exist (roomID = ".concat(r,", objectId = ").concat(t,")"))}else console.error("RoomManager.updateObjectTransform :: RoomRuntimeMemory doesn't exist (roomID = ".concat(r,")"))}else console.error("RoomManager.updateObjectTransform :: RoomID not found (userID = ".concat(o.id,")"))}},Vc=!1;setInterval(function(){return Cc(void 0,void 0,void 0,function(){return Ac(this,function(e){switch(e.label){case 0:return Vc?[2]:(Vc=!0,[4,zc.saveRooms()]);case 1:return e.sent(),Vc=!1,[2]}})})},3e3);const Wc=zc;var Jc=function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();const Yc=function(e){function t(t){var n=e.call(this)||this;return n.message=t,n}return Jc(t,e),t.prototype.encode=function(e){new zo(this.message).encode(e)},t.decode=function(e){return new t(zo.decode(e).str)},t}(Go);var Hc=[[0,{signalType:"objectDespawnParams",throttleInterval:0,decode:function(e){return uc.decode(e)}}],[1,{signalType:"objectDesyncResolveParams",throttleInterval:0,decode:function(e){return Vr.decode(e)}}],[2,{signalType:"objectMessageParams",throttleInterval:0,decode:function(e){return Wo.decode(e)}}],[3,{signalType:"objectSpawnParams",throttleInterval:0,decode:function(e){return na.decode(e)}}],[4,{signalType:"objectSyncParams",throttleInterval:0,decode:function(e){return rr.decode(e)}}],[5,{signalType:"roomChangeRequestParams",throttleInterval:2e3,decode:function(e){return cr.decode(e)}}],[6,{signalType:"roomRuntimeMemory",throttleInterval:0,decode:function(e){return Ba.decode(e)}}],[7,{signalType:"updateVoxelGridParams",throttleInterval:0,decode:function(e){return kc.decode(e)}}],[8,{signalType:"userCommandParams",throttleInterval:1e3,decode:function(e){return Yc.decode(e)}}]],Xc={},Qc={};Hc.forEach(function(e){if(e[0]<0||e[0]>255)throw new Error("Signal type index is outside of its valid range (".concat(e[0],")"));Xc[e[0]]=e[1],Qc[e[1].signalType]=e[0]});var Zc={getConfigByType:function(e){var t=Zc.getIndexByType(e);return Zc.getConfigByIndex(t)},getConfigByIndex:function(e){var t=Xc[e];return null==t&&console.error("getConfigByIndex :: Invalid signal type index (signalTypeIndex = ".concat(e,")")),t},getIndexByType:function(e){var t=Qc[e];return null==t&&console.error("getIndexByType :: Invalid signal type (signalType = ".concat(e,")")),t},getMaxIndex:function(){return Hc.map(function(e){return e[0]}).reduce(function(e,t){return t>=e?t:e})}};const Kc=Zc,$c=function(){function e(e){this.throttleTimestamps={},this.socket=e,this.connectTime=Date.now(),this.pendingSignalsToUserByTypeIndex=new Array(Kc.getMaxIndex()+1)}return e.prototype.onReceivedSignalFromUser=function(e,t){var n=this,o=Kc.getConfigByType(e).throttleInterval;this.socket.on(e,function(r){if(o>0){var a=Date.now(),c=n.throttleTimestamps[e];if(c&&a-c<o)return;n.throttleTimestamps[e]=a}t(r)})},e.prototype.addPendingSignalToUser=function(e,t){var n=Kc.getIndexByType(e);if(null!=n){var o=this.pendingSignalsToUserByTypeIndex[n];null==o&&(o=[],this.pendingSignalsToUserByTypeIndex[n]=o),o.push(t)}else console.error("Failed to add the incoming signal. The signal's type is unknown (signalType = ".concat(e,")"))},e.prototype.tryUpdateLatestPendingSignalToUser=function(e,t){var n=Kc.getIndexByType(e);if(null==n)return console.error("Failed to add the incoming signal. The signal's type is unknown (signalType = ".concat(e,")")),!1;var o=this.pendingSignalsToUserByTypeIndex[n];if(null==o)return!1;var r=o.length-1;return!(r<0||(t(o[r]),0))},e.prototype.processAllPendingSignalsToUser=function(){for(var e=Ya(),t=0;t<this.pendingSignalsToUserByTypeIndex.length;++t){var n=this.pendingSignalsToUserByTypeIndex[t];n&&n.length>0&&(new Zr(t).encode(e),new Oa(n,65535).encode(e),n.length=0)}var o=Ha(e);e.byteIndex>0&&this.socket.emit("signalBatch",o)},e}();var ei=function(e,t,n,o){return new(n||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())})},ti=function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},ni={handleCommand:function(e,t){return ei(void 0,void 0,void 0,function(){var n,o;return ti(this,function(r){switch(r.label){case 0:return 0==(n=t.message.split(" ")).length?(L.log("No user command type specified",{params:t},"high","error"),[2]):"tutorialStep"===(o=n[0])?[3,1]:[3,3];case 1:return[4,oi(e,n,t)];case 2:return r.sent(),[3,4];case 3:return L.log("Unknown user command type",{commandType:o,params:t},"high","error"),[3,4];case 4:return[2]}})})}};function oi(e,t,n){return ei(this,void 0,void 0,function(){var o;return ti(this,function(r){switch(r.label){case 0:return t.length<2?(L.log("No tutorial step specified",{params:n},"high","error"),[2]):(o=parseInt(t[1]),isNaN(o)?(L.log("Invalid tutorial step specified",{params:n},"high","error"),[2]):e.tutorialStep==o?(L.log("Tutorial step already set",{params:n},"high","error"),[2]):(e.tutorialStep=o,[4,Cn.setUserTutorialStep(e.id,o)]));case 1:return r.sent(),[2]}})})}const ri=ni;var ai,ci=function(e,t,n,o){return new(n||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())})},ii=function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}},si={},ui={saveAndDisconnectAllUsers:function(){return ci(void 0,void 0,void 0,function(){var e,t,n,o;return ii(this,function(r){switch(r.label){case 0:return[4,Wc.saveAllUserGameplayStates(si)];case 1:r.sent(),e=0,t=Object.entries(si),r.label=2;case 2:return e<t.length?((n=t[e])[0],o=n[1],[4,Wc.changeUserRoom(o,void 0,!1,!1)]):[3,5];case 3:r.sent(),o.socket.disconnect(!0),r.label=4;case 4:return e++,[3,2];case 5:return[2]}})})},init:function(e,t){(ai=e.of("/game_sockets")).use(t),ai.on("connection",function(e){return ci(void 0,void 0,void 0,function(){var t,n,o,r,a,c,i,s,u;return ii(this,function(l){switch(l.label){case 0:return t=new $c(e),n=e.handshake.auth,console.log("(GameSockets) Client connected :: ".concat(JSON.stringify(n))),null==si[n.id]?[3,2]:(console.warn("(GameSockets) Replacing existing socket for userID = ".concat(n.id," (likely page refresh)")),o=si[n.id],delete si[n.id],[4,Wc.changeUserRoom(o,void 0,!1)]);case 1:l.sent(),o.socket.disconnect(!0),l.label=2;case 2:return si[n.id]=t,t.onReceivedSignalFromUser("objectSyncParams",function(e){var n=new za(new Uint8Array(e)),o=rr.decode(n);Wc.updateObjectTransform(t,o.objectId,o.transform)}),t.onReceivedSignalFromUser("objectMessageParams",function(e){var n=new za(new Uint8Array(e)),o=Wo.decode(n);Wc.sendObjectMessage(t,o)}),t.onReceivedSignalFromUser("userCommandParams",function(e){return ci(void 0,void 0,void 0,function(){var t,o;return ii(this,function(r){switch(r.label){case 0:return t=new za(new Uint8Array(e)),o=Yc.decode(t),[4,ri.handleCommand(n,o)];case 1:return r.sent(),[2]}})})}),t.onReceivedSignalFromUser("updateVoxelGridParams",function(e){var n=new za(new Uint8Array(e)),o=kc.decode(n);Wc.updateVoxelGrid(t,o)}),t.onReceivedSignalFromUser("roomChangeRequestParams",function(e){return ci(void 0,void 0,void 0,function(){var n,o;return ii(this,function(r){switch(r.label){case 0:return n=new za(new Uint8Array(e)),o=cr.decode(n),[4,Wc.changeUserRoom(t,o.roomID,!0)];case 1:return r.sent(),[2]}})})}),e.on("disconnect",function(){return ci(void 0,void 0,void 0,function(){return ii(this,function(e){switch(e.label){case 0:return console.log("(GameSockets) Client disconnected :: ".concat(JSON.stringify(n))),null==si[n.id]?(console.error("SocketUserContext with userID doesn't exist (userID = ".concat(n.id,")")),[2]):(delete si[n.id],[4,Wc.changeUserRoom(t,void 0,!1)]);case 1:return e.sent(),[2]}})})}),[4,Wc.changeUserRoom(t,n.lastRoomID,!1)];case 3:if(l.sent())return[3,7];for(r=void 0,a=0,c=Object.entries(Wc.roomRuntimeMemories);a<c.length;a++)if(i=c[a],s=i[0],i[1].room.roomType===Ra.Hub){r=s;break}return r?[3,5]:[4,yo.withRoomType(Ra.Hub)];case 4:(u=l.sent()).success&&u.data.length>0&&(r=u.data[0].id),l.label=5;case 5:return r?[4,Wc.changeUserRoom(t,r,!1)]:[3,7];case 6:l.sent(),l.label=7;case 7:return[2]}})})}),setInterval(function(){for(var e=0,t=Object.values(si);e<t.length;e++)t[e].processAllPendingSignalsToUser()},200),setInterval(function(){return ci(void 0,void 0,void 0,function(){var e,t,n,o,r;return ii(this,function(a){switch(a.label){case 0:e=0,t=Object.entries(si),a.label=1;case 1:return e<t.length?(n=t[e],o=n[0],(r=n[1]).socket.connected?[3,3]:(console.warn("(GameSockets) Stale socket detected, cleaning up :: userID = ".concat(o)),delete si[o],[4,Wc.changeUserRoom(r,void 0,!1)])):[3,4];case 2:a.sent(),a.label=3;case 3:return e++,[3,1];case 4:return[2]}})})},3e4)}};const li=ui,fi=require("cookie");var di=new Set;function pi(e){var t=this;return function(n,o){return r=t,a=void 0,i=function(){var t,r,a,c,i,s,u;return function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}(this,function(l){switch(l.label){case 0:return l.trys.push([0,2,,3]),t=n.request.headers.cookie,console.log("Authenticating socket (ID: ".concat(n.id,")")),t?(r=fi.parse(t),(a=r[Ht()])&&(c=Qt(a))?[4,Cn.findUserById(c)]:(o(new Error(W.getErrorPageURL("auth-failure"))),[2])):(o(new Error(W.getErrorPageURL("auth-failure"))),[2]);case 1:return(i=l.sent())?(s=Cn.fromDBType(i),di.has(s.id)?(o(new Error(W.getErrorPageURL("auth-duplication"))),[2]):e(s)?(di.add(s.id),n.on("disconnect",function(){di.has(s.id)?di.delete(s.id):console.error('User "'.concat(s.id,'" is already disconnected.'))}),n.handshake.auth=s,o(),[3,3]):(o(new Error(W.getErrorPageURL("auth-no-permission"))),[2])):(o(new Error(W.getErrorPageURL("auth-failure"))),[2]);case 2:return u=l.sent(),console.error("Socket auth error: ".concat(u)),o(new Error(W.getErrorPageURL("auth-failure"))),[3,3];case 3:return[2]}})},new((c=void 0)||(c=Promise))(function(e,t){function n(e){try{s(i.next(e))}catch(e){t(e)}}function o(e){try{s(i.throw(e))}catch(e){t(e)}}function s(t){var r;t.done?e(t.value):(r=t.value,r instanceof c?r:new c(function(e){e(r)})).then(n,o)}s((i=i.apply(r,a||[])).next())});var r,a,c,i}}var hi=function(e,t,n,o){return new(n||(n=Promise))(function(r,a){function c(e){try{s(o.next(e))}catch(e){a(e)}}function i(e){try{s(o.throw(e))}catch(e){a(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}s((o=o.apply(e,t||[])).next())})},yi=function(e,t){var n,o,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},c=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return c.next=i(0),c.throw=i(1),c.return=i(2),"function"==typeof Symbol&&(c[Symbol.iterator]=function(){return this}),c;function i(i){return function(s){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;c&&(c=0,i[0]&&(a=0)),a;)try{if(n=1,o&&(r=2&i[0]?o.return:i[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,i[1])).done)return r;switch(o=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,o=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){a.label=i[1];break}if(6===i[0]&&a.label<r[1]){a.label=r[1],r=i;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(i);break}r[2]&&a.ops.pop(),a.trys.pop();continue}i=t.call(e,a)}catch(e){i=[6,e],o=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}};!function(){hi(this,void 0,void 0,function(){var e,t,n,o,a,i,u=this;return yi(this,function(f){switch(f.label){case 0:return console.log("========================================\nEnv Variables in Server:\n========================================\n    MODE: ".concat(process.env.MODE,"\n    SKIP_SSG: ").concat(process.env.SKIP_SSG,"\n    PORT: ").concat(process.env.PORT,"\n    SKIP_CSS_COMPILE: ").concat(process.env.SKIP_CSS_COMPILE,"\n    SKIP_CLIENT_COMPILE: ").concat(process.env.SKIP_CLIENT_COMPILE,"\n    SKIP_SERVER_COMPILE: ").concat(process.env.SKIP_SERVER_COMPILE,"\n========================================")),e="dev"==process.env.MODE,"true"==process.env.SKIP_SSG?[3,4]:e?[4,zt()]:[3,2];case 1:return f.sent(),[3,4];case 2:return"ssg"!=process.env.MODE?[3,4]:[4,zt()];case 3:return f.sent(),[2];case 4:return process.env.JWT_SECRET_KEY?process.env.GOOGLE_OAUTH_CLIENT_ID?process.env.GOOGLE_OAUTH_CLIENT_SECRET?[4,yo.withRoomType(Ra.Hub)]:(console.error("[Premature Server Termination] :: Secret not found :: GOOGLE_OAUTH_CLIENT_SECRET"),[2]):(console.error("[Premature Server Termination] :: Secret not found :: GOOGLE_OAUTH_CLIENT_ID"),[2]):(console.error("[Premature Server Termination] :: Secret not found :: JWT_SECRET_KEY"),[2]);case 5:return(t=f.sent()).success?0!=t.data.length?[3,7]:[4,ac.createRoom("hub",Ra.Hub,"",0,1,2,"".concat(W.getEnvStaticURL(),"/app/assets/texture_packs/default.jpg"))]:(console.error("[Premature Server Termination] :: Failed to search for hub rooms."),[2]);case 6:if(!f.sent().success)return console.error("[Premature Server Termination] :: Failed to create a hub room."),[2];f.label=7;case 7:return n=r()(),o=c().createServer(n),n.set("view engine","ejs"),n.set("trust proxy",!0),n.use(s().json()),n.use(s().urlencoded({extended:!0})),n.use(l()()),n.use(d()()),function(e){var t=this;"dev"==process.env.MODE?(e.get("/",function(e,n){return Mo(t,void 0,void 0,function(){var t;return Eo(this,function(o){switch(o.label){case 0:return[4,N.read(e.url+"index.html")];case 1:return t=o.sent(),n.status(200).setHeader("content-type","text/html").send(Z.postProcessHTML(t)),[2]}})})}),e.get(/.*\.html$/,function(e,n){return Mo(t,void 0,void 0,function(){var t;return Eo(this,function(o){switch(o.label){case 0:return[4,N.read(e.url)];case 1:return t=o.sent(),n.status(200).setHeader("content-type","text/html").send(Z.postProcessHTML(t)),[2]}})})}),e.get("/app/bundle.js",function(e,t){t.status(200).setHeader("content-type","text/javascript").sendFile(N.getAbsoluteFilePath("bundle.js","dist/client"))}),e.get("/app/style.css",function(e,t){t.sendFile(N.getAbsoluteFilePath("style.css","dist/client"))}),e.get(/.*\.js$/,function(e,n){return Mo(t,void 0,void 0,function(){return Eo(this,function(t){return n.status(200).setHeader("content-type","text/javascript").sendFile(N.getAbsoluteFilePath(e.url)),[2]})})}),e.get(/(.*\.css)|(.*\.jpg)|(.*\.png)|(.*\.ico)|(.*\.atom)|(.*\.xml)|(.*\.pdf)|(.*\.glb)$/,function(e,n){return Mo(t,void 0,void 0,function(){return Eo(this,function(t){return n.sendFile(N.getAbsoluteFilePath(e.url)),[2]})})})):e.get("/",function(e,t){t.status(200).send("Server is running")}),e.get("/robots.txt",function(e,t){t.type("text/plain"),t.send("User-agent: *\nDisallow: /socket.io/")}),e.get("/debug-connection",function(e,t){t.json({status:"ok",headers:e.headers,secure:e.secure,protocol:e.protocol,hostname:e.hostname,ip:e.ip,ips:e.ips,timestamp:(new Date).toISOString()})}),e.use("/".concat(b),Do.apiRateLimiter,To),e.use("/",Do.pageRateLimiter,eo)}(n),o.listen(process.env.PORT,function(){console.log("---------------------------------------------"),console.log("Listening to port ".concat(process.env.PORT,"."))}),function(e){var t=new(Bo().Server)(e,{pingTimeout:5e3,pingInterval:1e4,cors:{origin:W.getEnvDynamicURL(),methods:["GET","POST"]},allowEIO3:!0,transports:["websocket","polling"],allowRequest:function(e,t){var n=e.headers["user-agent"]||"";if(console.log("[allowRequest] User-Agent: ".concat(n,", URL: ").concat(e.url)),/bot|crawler|spider|robot|crawling/i.test(n))return console.log("[allowRequest] Blocking bot: ".concat(n)),t(null,!1);console.log("[allowRequest] Allowing connection from: ".concat(n)),t(null,!0)}});t.engine.on("connection_error",function(e){console.error("Socket connection error :: (code = ".concat(e.code,", message = ").concat(e.message,", req = ").concat(JSON.stringify(e.req),", context = ").concat(JSON.stringify(e.context),")"))}),No.init(t,"dev"==process.env.MODE?function(e,t){return t()}:pi(function(e){return 0==e.userType})),li.init(t,pi(function(e){return!0}))}(o),a=0,setInterval(function(){var e=a;a=(a+1)%3,Cn.deleteStaleGuestsByTier(e).then(function(t){t>0&&L.logRaw("Cleaned up ".concat(t," stale ").concat(j[e]," guest accounts"),"low","info")}).catch(function(t){return L.log("Guest cleanup failed",{err:t,phase:e},"high","error")})},m),i=function(e){return hi(u,void 0,void 0,function(){return yi(this,function(t){switch(t.label){case 0:return console.log("[".concat(e,"] Graceful shutdown initiated...")),console.log("Saving all rooms and user gameplay states before shutdown..."),[4,Wc.saveRooms(!0)];case 1:return t.sent(),console.log("All rooms saved."),[4,li.saveAndDisconnectAllUsers()];case 2:return t.sent(),console.log("All users saved and disconnected."),o.close(function(){console.log("HTTP server closed."),process.exit(0)}),setTimeout(function(){console.error("Forced shutdown after timeout."),process.exit(1)},1e4),[2]}})})},process.on("SIGINT",function(){return i("SIGINT")}),process.on("SIGTERM",function(){return i("SIGTERM")}),[2]}})})}()})();